<!-- ============ PART 1 / 20 ============ -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø²ÙŠØ§Ø±Ø© Ù…Ø¹Ù„Ù… Ù¡Ù¤Ù¤Ù§Ù‡Ù€</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700&family=Cairo:wght@600;700&display=swap" rel="stylesheet">
<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<!-- PDF.js (Ù„Ù„Ø§Ø³ØªØ±Ø§Ø¯ Ù…Ù† PDF Ø§Ù„Ù†ØµÙ‘ÙŠ) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.min.js"></script>

<style>
:root{
  --moe-dark:#0c594e;--moe-green:#0f7a66;--moe-lite:#e8f4f1;--ink:#123b37;--line:#cfe1dd;--border:#e6efec;--bg:#fbfdfc;
  --good:#16a34a;--mid:#f59e0b;--bad:#ef4444;--base:clamp(14px,1.15vw + 10px,16.5px);
  --rowA:#f7fdfa; --rowB:#ffffff; --warn:#e11d48
}
*{box-sizing:border-box}
html,body{margin:0;background:#fff;color:var(--ink);font-family:"Tajawal",system-ui;font-size:var(--base);min-height:100%}
#page{width:min(1200px,100vw);margin-inline:auto}
.wrap{padding:clamp(8px,2vw,16px)}
.hidden{display:none}
.input-error{border-color:var(--warn)!important;background:#fff5f7!important;box-shadow:0 0 0 2px rgba(225,29,72,.12) inset}

/* ======== HEADER IMAGE (NO TEXT) ======== */
.header-img{
  width:100%;
  border-radius:18px;
  overflow:hidden;
  border:1px solid var(--border);
  background:#0c594e;
  height:auto;
}
.header-img img{
  width:100%;
  height:auto;
  display:block;
  object-fit:contain;
  background:#0c594e;
}

/* ======== TITLE ROW + HIJRI DATE BADGE ======== */
.titleRow{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  flex-wrap:wrap;
  margin:10px 0 6px;
}
h1{
  margin:0;
  color:var(--moe-green);
  font-family:"Cairo","Tajawal";
  font-size:clamp(18px,1.6vw + 14px,26px);
  text-align:center
}
.dateBadge{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  background:linear-gradient(180deg,#ffffff,var(--moe-lite));
  color:var(--moe-dark);
  font-weight:900;
  font-size:12px;
  white-space:nowrap;
  box-shadow:0 8px 22px rgba(12,89,78,.08);
}

/* Ø´Ø±ÙŠØ· Ø£Ø¯ÙˆØ§Øª */
.toolbar-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0 10px;justify-content:center}
.toolbar-row .btn-ic{padding:7px 10px}

/* Ø¹Ø¯Ø³Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ */
.lens-wrap{position:relative}
.lens-menu{position:absolute;top:calc(100% + 6px);inset-inline-start:0;min-width:min(560px,96vw);background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:0 16px 48px rgba(0,0,0,.2);padding:10px;display:none;z-index:1700}
.lens-menu .row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.lens-menu .row .fld{flex:1}
.lens-menu select{flex:1;height:40px;border:1px solid var(--line);border-radius:10px;padding:0 10px;background:#fff;font:inherit;text-align:center}

/* Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚ */
.box{border:1px solid var(--border);border-radius:14px;background:var(--bg);margin-top:10px;overflow:hidden}
.box h3{margin:0;padding:10px 12px;border-bottom:1px solid var(--border);font-size:15px;color:var(--moe-dark);display:flex;gap:10px;align-items:center;justify-content:space-between}
.grid{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:8px}
.fld{height:38px;border:1px solid var(--line);border-radius:10px;padding:0 10px;background:#fff;font:inherit;text-align:center;width:100%}
.fld-inline{border:0;background:transparent;padding:6px 8px;text-align:center;border-radius:6px}
.fld-inline:focus{outline:2px solid rgba(15,122,102,0.06);background:#fff}

/* Ø£Ø²Ø±Ø§Ø± Ø¹Ø§Ù…Ø© */
.btn-ic{display:inline-flex;gap:8px;align-items:center;padding:9px 12px;border-radius:12px;border:1px solid var(--moe-green);background:var(--moe-green);color:#fff;font-weight:800;cursor:pointer;font-size:clamp(12px,.6vw + 10px,14px);transition:all .12s ease;box-shadow:0 6px 18px rgba(15,122,102,0.08)}
.btn-ic:hover{background:var(--moe-dark);transform:translateY(-1px)}
.btn-ic svg{width:18px;height:18px}
.btn-ic.tiny{padding:6px 8px}
</style>
<!-- ============ PART 2 / 20 ============ -->
<style>
/* Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª */
.hmeterTop{margin:10px auto 6px;text-align:center;display:flex;flex-direction:column;align-items:center;gap:6px}
.hmeterTop .metaLine{
  font-size:12.6px;
  color:var(--moe-dark);
  font-weight:900;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  margin-top:2px
}
.globalInline{font-family:"Cairo";font-size:12px;font-weight:900}
.globalInline.good{color:var(--good)}.globalInline.mid{color:var(--mid)}.globalInline.bad{color:var(--bad)}
.hbar{position:relative;width:min(700px,95vw);height:14px;border:1px solid var(--border);border-radius:999px;background:linear-gradient(90deg,#ef4444 0%,#f59e0b 50%,#16a34a 100%);margin:0 auto}
.hthumb{position:absolute;top:50%;transform:translate(-50%,-50%);width:18px;height:18px;border-radius:50%;background:#fff;border:3px solid var(--moe-dark)}

.visits{
  display:flex;
  gap:clamp(12px,2vw,24px);
  align-items:flex-start;
  justify-content:center;
  flex-wrap:nowrap;         /* ØµÙ ÙˆØ§Ø­Ø¯ Ø¯Ø§Ø¦Ù…Ù‹Ø§ */
  overflow-x:auto;          /* ØªÙ…Ø±ÙŠØ± Ø£ÙÙ‚ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ÙŠÙ‚ */
  -webkit-overflow-scrolling:touch;
  padding-bottom:6px
}
.visits::-webkit-scrollbar{height:10px}
.visits::-webkit-scrollbar-thumb{background:#cfe1dd;border-radius:999px;border:2px solid #fff}
.visits::-webkit-scrollbar-track{background:transparent}

.visitCard{display:flex;flex-direction:column;align-items:center;gap:8px;position:relative;min-width:160px;flex:0 0 auto}
.donut{width:clamp(92px, 9vw + 60px, 160px);height:auto;cursor:pointer}
.donut .ring{transform:rotate(-90deg);transform-origin:50% 50%;transition:stroke-dasharray .45s ease,stroke .3s ease}
.donut text{font-weight:800;fill:var(--moe-dark);font-size:13px}
.chip{background:var(--moe-lite);border:1px dashed var(--line);padding:4px 10px;border-radius:999px;font-size:clamp(11px,.6vw + 9px,12px);color:var(--moe-dark);cursor:pointer;white-space:nowrap}
.visitLabel{font-family:"Cairo";font-weight:700;color:var(--moe-dark);font-size:clamp(13px,.8vw + 10px,16px);white-space:nowrap}

.hmeter{display:flex;flex-direction:column;gap:6px;align-items:center;margin:6px 0 8px}
.hbarSmall{position:relative;width:min(680px,95vw);height:12px;border:1px solid var(--border);border-radius:999px;background:linear-gradient(90deg,#ef4444 0%,#f59e0b 50%,#16a34a 100%)}
.hthumbSmall{position:absolute;top:50%;transform:translate(-50%,-50%);width:18px;height:18px;border-radius:50%;background:#fff;border:3px solid var(--moe-dark)}
.hlbl{display:flex;gap:8px;align-items:center;color:var(--moe-dark);font-weight:800}

/* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³Ø© */
.table-responsive{width:100%;overflow:auto}
.tbl{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
.tbl th,.tbl td{border:1px solid var(--line);padding:6px;background:#fff;vertical-align:middle;text-align:center;word-wrap:break-word;font-size:12px}
.tbl thead th{background:var(--moe-dark)!important;color:#fff!important}
tr.field-start:nth-of-type(odd) td{background:var(--rowA)}
tr.field-start:nth-of-type(even) td{background:var(--rowB)}
tr.field-row:nth-of-type(odd) td{background:var(--rowA)}
tr.field-row:nth-of-type(even) td{background:var(--rowB)}
#learningHead th:nth-child(1){width:42px}
#learningHead th:nth-child(2){width:140px}
#learningHead th:nth-child(3){width:270px}
#learningHead th:nth-child(4){width:240px}
#learningHead th:nth-child(5){width:200px}
#learningHead th:nth-child(6){width:200px}
.tbl td.domain-cell{background:#f3faf8;text-align:center;vertical-align:middle;font-weight:800}
.item-cell{padding:6px 8px;text-align:center}
.item-title{display:block;font-weight:800;color:var(--moe-dark);font-size:13px}
.tbl tfoot.tfoot-brand td{background:var(--moe-lite);border-top:3px solid var(--moe-green);padding:4px 6px}
</style>
<!-- ============ PART 3 / 20 ============ -->
<style>
/* Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø¯Ø§Ø¡ */
.level{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;align-items:stretch;width:100%}
.level button{
  --dot:#d1d5db;border:1px solid var(--line);background:linear-gradient(180deg,#ffffff,#f8faf9);border-radius:999px;cursor:pointer;
  font-weight:800;display:inline-flex;align-items:center;justify-content:center;gap:10px;transition:.12s;width:100%;padding:10px 0;font-size:13.5px;box-shadow:0 4px 14px rgba(0,0,0,.06)
}
.level button::before{content:"";width:12px;height:12px;border-radius:50%;background:var(--dot)}
.level button:hover{transform:translateY(-1px);box-shadow:0 12px 26px rgba(0,0,0,.1)}
.level button[data-v="1"]{--dot:#f87171}
.level button[data-v="2"]{--dot:#fbbf24}
.level button[data-v="3"]{--dot:#22c55e}
.level button.active{background:linear-gradient(180deg,#f7fffb,#ecfdf5);box-shadow:0 0 0 2px #cfe8df inset,0 8px 24px rgba(0,0,0,.06)}
.level button.active[data-v="1"]{background:linear-gradient(180deg,#fff8f8,#ffecec);border-color:#f2bcbc;color:#b42318}
.level button.active[data-v="2"]{background:linear-gradient(180deg,#fffaf0,#fff1cc);border-color:#f2d3a2;color:#a8620a}
.level button.active[data-v="3"]{background:linear-gradient(180deg,#f0fff6,#dcfce7);border-color:#b9e4c8;color:#0f6a3b}

/* Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø§Ù†Ø¯Ø© */
#toolsTbl thead th:nth-child(1){width:42px}
#toolsTbl thead th:nth-child(2){width:260px}
#toolsTbl thead th:nth-child(3){width:86px}
#toolsTbl thead th:nth-child(4){width:210px}
#toolsTbl thead th:nth-child(5){width:260px}
.td-proof{text-align:center;width:1%;white-space:nowrap}
.td-proof input[type="checkbox"]{width:18px;height:18px;accent-color:var(--moe-green);cursor:pointer}
.tool-reason{width:100%;min-height:56px;border:1px dashed var(--line);border-radius:10px;background:#fff;padding:6px 8px;font:inherit;font-size:11.5px;resize:vertical;white-space:pre-wrap}
.tool-title{font-weight:800;color:var(--moe-dark);font-size:13.2px;text-align:center}
.tool-brief{display:block;font-size:11.2px;opacity:.9;margin-top:3px;text-align:center}

/* Ø§Ù„Ø¯Ø¹Ù… */
#supportArea{width:100%;min-height:130px;border:1px solid #b9e4c8;background:#f9fefb;color:#0f6a3b;border-radius:12px;padding:10px 12px;resize:none;font:inherit;line-height:1.9}

/* Ø§Ù„Ø­Ø§ÙØ¸Ø© / Snackbar */
#approvedPanel{position:fixed;left:50%;transform:translateX(-50%);bottom:88px;min-width:min(520px,92vw);max-width:92vw;background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 12px 40px rgba(0,0,0,.15);padding:0;display:none;z-index:1500}
.ap-head{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);padding:10px}
.ap-close{border:1px solid var(--line);background:#fff;border-radius:8px;padding:4px 10px;cursor:pointer}
#approvedList{display:flex;flex-wrap:wrap;gap:6px;padding:12px;max-height:40vh;overflow:auto}
.name-chip{padding:6px 10px;border-radius:999px;border:1px dashed var(--line);background:#fafafa;cursor:pointer}

/* Snackbar */
#snackbar{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;min-width:min(520px,92vw);border-radius:14px;padding:10px 14px;box-shadow:0 12px 34px rgba(0,0,0,.12);display:none;z-index:2000;text-align:center;font-weight:800}
.snack-ok{background:#eaffea;border:1px solid #b7e1b7;color:#146c2e}.snack-err{background:#fff0f0;border:1px solid #f1b7b7;color:#9c1d1d}
.footer-rights{margin:8px 0 14px;text-align:center;font-size:11px;color:var(--moe-dark)}
</style>
<!-- ============ PART 4 / 20 ============ -->
<style>
/* Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª */
#commsPanel{position:fixed;left:50%;transform:translateX(-50%);top:10%;min-width:min(640px,96vw);max-width:96vw;background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 18px 48px rgba(0,0,0,.2);padding:0;display:none;z-index:1800}
.comms-head{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);padding:10px}
.comms-body{padding:12px;display:flex;flex-direction:column;gap:10px}
.comms-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.comms-row .fld{flex:1}
textarea.comms-preview{min-height:200px;border:1px dashed var(--line);border-radius:10px;padding:8px;font:inherit;white-space:pre-wrap}

/* Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ø­ Ø§Ù„ÙƒØ¨ÙŠØ±Ø© */
#helpPanel{position:fixed;left:50%;transform:translateX(-50%);top:6%;min-width:min(760px,96vw);max-width:96vw;background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 18px 48px rgba(0,0,0,.2);padding:0;display:none;z-index:1850;max-height:88vh}
.help-head{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);padding:10px}
.help-body{padding:12px;overflow:auto}
.help-body h3{margin:8px 0 6px;color:var(--moe-green);font-family:"Cairo";font-size:18px}
.help-body p{margin:6px 0}
.help-body ul{margin:6px 0 10px 0;padding-inline-start:18px}
.help-body li{margin:4px 0}
.help-badge{display:inline-block;margin:2px 4px 6px 0;padding:4px 8px;border-radius:10px;background:var(--moe-lite);color:var(--moe-dark);border:1px solid var(--border);font-weight:700;font-size:12px}
.help-note{background:#fefce8;border:1px solid #fde68a;color:#92400e;padding:8px 10px;border-radius:10px;margin:6px 0}
.help-privacy{background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;padding:8px 10px;border-radius:10px;margin:6px 0}
.help-close{border:1px solid var(--line);background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}

/* Ø£Ø²Ø±Ø§Ø± Ø³ÙÙ„ÙŠØ© */
.bottom-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center;padding:10px;border:1px solid var(--border);border-radius:14px;background:#fbfdfc;margin-top:12px}

/* Ø£Ø³Ù‡Ù… ØªÙ…Ø±ÙŠØ± */
.scroll-arrows{position:fixed;right:8px;top:50%;transform:translateY(-50%);display:flex;flex-direction:column;gap:10px;z-index:2100}
.scroll-arrows button{background:#10b981;color:#fff;border:1px solid #0f7a66;border-radius:12px;padding:8px 10px;font-weight:900;cursor:pointer;box-shadow:0 10px 26px rgba(16,185,129,.2)}
.scroll-arrows button:hover{filter:saturate(120%);transform:translateY(-1px)}

/* Ø´Ø§Ø±Ø© Ù…ØµØ¯Ø± Ø§Ù„Ø¯Ø¹Ù… ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ± */
.srcBadge{display:inline-block;padding:.1rem .4rem;border-radius:8px;border:1px solid var(--moe-green);color:var(--moe-green);background:#f5fffb;margin-inline-start:6px;font-size:10px;font-weight:800}

/* Ù…ÙØ¹Ø§Ù„Ø¬ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ */
#importWizard{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:2200}
#wizCard{background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 18px 48px rgba(0,0,0,.2);width:min(920px,96vw);max-height:86vh;display:flex;flex-direction:column}
#wizHead{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid var(--border)}
#wizBody{padding:12px;overflow:auto}
#wizRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
#wizRow select,#wizRow input{height:38px;border:1px solid var(--line);border-radius:10px;padding:0 10px;background:#fff;font:inherit}
#wizTbl{width:100%;border-collapse:collapse;table-layout:fixed}
#wizTbl th,#wizTbl td{border:1px solid var(--line);padding:6px;font-size:12px;text-align:center;background:#fff}
#wizFoot{display:flex;gap:8px;align-items:center;justify-content:flex-end;padding:10px;border-top:1px solid var(--border)}
.wiz-close{border:1px solid var(--line);background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}
.map-select{min-width:160px}
.help{font-size:12px;color:#0c594e}
.warn{color:#b42318;font-weight:800}

/* Ø£Ø²Ø±Ø§Ø± Ø¹Ø§Ø¦Ù…Ø© */
.fab-wrap{position:fixed;left:14px;bottom:18px;display:flex;flex-direction:column;gap:10px;z-index:2300}
.fab{
  display:inline-flex;align-items:center;justify-content:center;gap:8px;
  height:44px;min-width:44px;padding:0 14px;border-radius:999px;
  border:1px solid rgba(255,255,255,.22);
  background:linear-gradient(180deg,var(--moe-green),var(--moe-dark));
  color:#fff;font-weight:900;cursor:pointer;
  box-shadow:0 16px 44px rgba(12,89,78,.22), 0 0 0 3px rgba(15,122,102,.10);
  transition:.12s;
}
.fab:hover{transform:translateY(-2px);filter:saturate(115%)}
.fab.secondary{background:linear-gradient(180deg,#0fb3b0,#0c594e)}
.fab .mini{font-size:12px;font-weight:900}
.fab .ic{font-size:16px;line-height:1}

/* Ø·Ø¨Ø§Ø¹Ø© */
@media print{
  .toolbar-row,.scroll-arrows,.fab-wrap,#snackbar,#approvedPanel,#commsPanel,#importWizard,#helpPanel{display:none!important}
  body{background:#fff}
}

/* Responsive */
@media (max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
@media (prefers-reduced-motion:reduce){*{animation:none!important;transition:none!important}}
</style>
<!-- ============ PART 5 / 20 ============ -->
<style>
/* =========================
   INFO SECTION (SAFE V3)
   Ø¨Ø¯ÙˆÙ† Ø§Ù„ØªÙØ§Ù + Ø¨Ø¯ÙˆÙ† Ø§Ø¬ØªØ²Ø§Ø¡ + 5 Ø­Ù‚ÙˆÙ„ ÙÙ‚Ø·
   ========================= */

#boxInfo .infoShell{padding:12px}
#boxInfo .infoScroll{
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
  padding-bottom:6px;
}
#boxInfo .infoScroll::-webkit-scrollbar{height:10px}
#boxInfo .infoScroll::-webkit-scrollbar-thumb{
  background:#cfe1dd;border-radius:999px;border:2px solid #fff
}
#boxInfo .infoScroll::-webkit-scrollbar-track{background:transparent}

#boxInfo .infoCard{
  border:1px solid var(--border);
  background:linear-gradient(180deg,#ffffff,#fbfdfc);
  border-radius:14px;
  box-shadow:0 10px 26px rgba(12,89,78,.06);
  padding:12px;
  min-width:980px; /* ØµÙ Ø«Ø§Ø¨ØªØŒ ÙˆØ§Ù„Ø¬ÙˆØ§Ù„ ØªÙ…Ø±ÙŠØ± */
}

#boxInfo .infoRow{
  display:grid;
  gap:10px;
  align-items:center;
}
#boxInfo .infoRow.row1{
  grid-template-columns:repeat(2,minmax(260px,1fr));
  margin-bottom:10px;
}
#boxInfo .infoRow.row2{
  grid-template-columns:
    minmax(260px, 1.55fr)  /* Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… (Ø£ÙƒØ¨Ø±) */
    minmax(140px, 0.70fr)  /* Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© (Ø£ØµØºØ±) */
    minmax(170px, 0.85fr)  /* Ø§Ù„ØªØ®ØµØµ/Ø§Ù„Ù…Ø§Ø¯Ø© (Ø£ØµØºØ±) */
    minmax(150px, 0.75fr)  /* Ø§Ù„Ù…Ø±ØªØ¨Ø© */
    minmax(260px, 1.45fr); /* Ø§Ù„ÙØµÙ„ + Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³ */
}

#boxInfo .lbl{
  font-size:11px;
  font-weight:900;
  color:var(--moe-dark);
  margin:0 2px 6px;
  opacity:.95;
  white-space:nowrap;
}

#boxInfo .infoCard .fld-inline{
  border:1px solid var(--line);
  background:#fff;
  height:42px;
  font-weight:900;
  color:var(--ink);
  border-radius:12px;
  box-shadow:0 6px 18px rgba(0,0,0,.04);
  padding:0 10px;
  text-align:center;

  white-space:nowrap;
  overflow:visible;
  text-overflow:clip;
}

#boxInfo #h-dir,
#boxInfo #h-school{
  background:linear-gradient(180deg,#f5fffb,#ffffff);
  border-color:#cfe1dd;
}

#boxInfo .infoCard .fld-inline::placeholder{
  color:#5d737a;
  font-weight:900;
  opacity:.75;
}

/* Ø¯Ù…Ø¬ Ø´ÙƒÙ„ÙŠ: Ø§Ù„ÙØµÙ„ + Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³ Ø¯Ø§Ø®Ù„ Ø¥Ø·Ø§Ø± ÙˆØ§Ø­Ø¯ */
.mergeField{
  display:flex;
  align-items:center;
  gap:8px;
  height:42px;
  padding:0 10px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  box-shadow:0 6px 18px rgba(0,0,0,.04);
}
.mergeIn{
  border:0;
  outline:0;
  background:transparent;
  font:inherit;
  font-weight:900;
  color:var(--ink);
  height:100%;
  text-align:center;
  min-width:0;
  width:100%;
  white-space:nowrap;
}
.mergeIn::placeholder{
  color:#5d737a;
  font-weight:900;
  opacity:.7;
}
.mergeSep{
  color:#9fb5b1;
  font-weight:900;
  user-select:none;
  white-space:nowrap;
}
</style>

</head>
<body>
<!-- ============ PART 6 / 20 ============ -->
<div id="page"><div class="wrap" id="sheet">

  <!-- HEADER IMAGE ONLY (NO TEXT) -->
  <div class="header-img" id="hdrBox">
    <img id="hdrImg" src="logo2.png" alt="Header">
  </div>

  <!-- Ø§Ù„Ø¹Ù†ÙˆØ§Ù† + ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… Ø¨Ø¬Ø§Ù†Ø¨Ù‡ -->
  <div class="titleRow">
    <h1>Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø²ÙŠØ§Ø±Ø© Ù…Ø¹Ù„Ù… Ù¡Ù¤Ù¤Ù§Ù‡Ù€</h1>
    <span class="dateBadge" id="todayHijri">â€”</span>
  </div>

  <!-- ØªØ§Ø±ÙŠØ® Ù…Ø®ÙÙŠ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ -->
  <input type="hidden" id="visitDateInline" value="">

  <!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± ØªØ­Øª Ø§Ù„Ø¹Ù†ÙˆØ§Ù† -->
  <div class="toolbar-row no-print">
    <span class="lens-wrap">
      <button class="btn-ic tiny" id="btnLens" title="Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ / Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯">ğŸ” Ø§Ù„Ø£Ø³Ù…Ø§Ø¡</button>
      <div class="lens-menu" id="lensMenu">
        <div class="row">
          <input id="lensSearch" class="fld" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡ÙˆÙŠØ©">
          <button class="btn-ic tiny" id="lensImport" title="Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel/CSV/PDF">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
          <button class="btn-ic tiny" id="lensTemplate" title="ØªØµØ¯ÙŠØ± Ù‚Ø§Ù„Ø¨ Excel/CSV">ğŸ“„ Ù‚Ø§Ù„Ø¨</button>
          <input type="file" id="excelInput" accept=".xlsx,.xls,.xlsm,.xlsb,.csv,.tsv,.txt,.xml,.ods,.fods,.pdf" style="display:none">
        </div>
        <div class="row"><select id="lensSelect" title="Ø§Ù„Ù…Ø¹Ù„Ù…ÙˆÙ†"></select></div>
      </div>
    </span>
    <button class="btn-ic tiny" id="btnVault" title="Ø§Ù„Ø­Ø§ÙØ¸Ø© (Ø§Ù„Ù…ÙØ²Ø§Ø±ÙˆÙ†)">ğŸ—‚ï¸ Ø§Ù„Ø­Ø§ÙØ¸Ø©</button>
    <button class="btn-ic tiny" id="btnReport" title="Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±">ğŸ“„ ØªÙ‚Ø±ÙŠØ±</button>
    <button class="btn-ic tiny" id="btnComms" title="Ù…Ø±Ø§Ø³Ù„Ø§Øª">âœ‰ï¸ Ù…Ø±Ø§Ø³Ù„Ø§Øª</button>
    <button class="btn-ic tiny" id="btnPDFAll" title="ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø«Ù„Ø§Ø« ÙÙŠ PDF ÙˆØ§Ø­Ø¯">ğŸ“„ Ø¨ÙŠ Ø¯ÙŠ Ø¥Ù</button>
  </div>

<!-- Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© -->
<div class="box" id="boxInfo">
  <h3><span>Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</span></h3>

  <div class="infoShell">
    <div class="infoScroll">
      <div class="infoCard">

        <!-- Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ -->
        <div class="infoRow row1">
          <div>
            <div class="lbl">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…</div>
            <input class="fld fld-inline" id="h-dir" placeholder="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…"
                   value="Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ©">
          </div>

          <div>
            <div class="lbl">Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</div>
            <input class="fld fld-inline" id="h-school" placeholder="Ø§Ù„Ù…Ø¯Ø±Ø³Ø©"
                   value="Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ Ø¨Ø§Ù„Ø®Ø¨Ø±">
          </div>
        </div>

        <!-- Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ -->
        <div class="infoRow row2">

          <div>
            <div class="lbl">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…</div>
            <input class="fld fld-inline req" id="tName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…">
          </div>

          <div>
            <div class="lbl">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</div>
            <input class="fld fld-inline" id="tId" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© (10 Ø£Ø±Ù‚Ø§Ù…)"
                   inputmode="numeric" maxlength="10">
          </div>

          <div>
            <div class="lbl">Ø§Ù„ØªØ®ØµØµ / Ø§Ù„Ù…Ø§Ø¯Ø©</div>
            <input class="fld fld-inline req" id="tSpec" placeholder="Ø§Ù„ØªØ®ØµØµ / Ø§Ù„Ù…Ø§Ø¯Ø©">
          </div>

          <div>
            <div class="lbl">Ø§Ù„Ù…Ø±ØªØ¨Ø©</div>
            <input class="fld fld-inline" id="degree" placeholder="Ø§Ù„Ù…Ø±ØªØ¨Ø©">
          </div>

          <div>
            <div class="lbl">Ø§Ù„ÙØµÙ„ + Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³</div>
            <div class="mergeField">
              <input class="mergeIn" id="class" placeholder="Ø§Ù„ÙØµÙ„">
              <span class="mergeSep">|</span>
              <input class="mergeIn" id="lesson" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³">
            </div>
          </div>

        </div>

      </div>
    </div>
  </div>
</div>
<!-- ============ PART 7 / 20 ============ -->
  <!-- Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª -->
  <div class="hmeterTop">
    <div class="metaLine"><span>Ø§Ù„Ù…Ø¤Ø´Ø± Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ù„Ø£Ø¯Ø§Ø¡:</span> <b id="globalPctInline" class="globalInline">Ù…ØªÙˆØ³Ø·</b></div>
    <div class="hbar"><div class="hthumb" id="globalThumb" style="left:0%"></div></div>
  </div>

  <!-- Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª -->
  <div class="visits">
    <div class="visitCard">
      <svg class="donut" id="v1" viewBox="0 0 120 120">
        <circle cx="60" cy="60" r="50" fill="none" stroke="#eef3f2" stroke-width="12"/>
        <circle id="v1ring" cx="60" cy="60" r="50" fill="none" stroke="#16a34a" stroke-width="12" stroke-dasharray="0 314" stroke-linecap="round" class="ring"/>
        <text x="60" y="64" text-anchor="middle" id="v1t">â€”</text>
      </svg>
      <div class="chip" id="v1h">â€”</div><div class="visitLabel">Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</div>
    </div>

    <div class="visitCard">
      <svg class="donut" id="v2" viewBox="0 0 120 120">
        <circle cx="60" cy="60" r="50" fill="none" stroke="#eef3f2" stroke-width="12"/>
        <circle id="v2ring" cx="60" cy="60" r="50" fill="none" stroke="#16a34a" stroke-width="12" stroke-dasharray="0 314" stroke-linecap="round" class="ring"/>
        <text x="60" y="64" text-anchor="middle" id="v2t">â€”</text>
      </svg>
      <div class="chip" id="v2h">â€”</div><div class="visitLabel">Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©</div>
    </div>

    <div class="visitCard">
      <svg class="donut" id="v3" viewBox="0 0 120 120">
        <circle cx="60" cy="60" r="50" fill="none" stroke="#eef3f2" stroke-width="12"/>
        <circle id="v3ring" cx="60" cy="60" r="50" fill="none" stroke="#16a34a" stroke-width="12" stroke-dasharray="0 314" stroke-linecap="round" class="ring"/>
        <text x="60" y="64" text-anchor="middle" id="v3t">â€”</text>
      </svg>
      <div class="chip" id="v3h">â€”</div><div class="visitLabel">Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø© (Ø¯Ø¹Ù…)</div>
    </div>
  </div>

  <div class="hmeter">
    <div class="hbarSmall"><div class="hthumbSmall" id="hThumb" style="left:0%"></div></div>
    <div class="hlbl"><span>Ù…Ø¤Ø´Ø± Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</span> <span id="kpiPct">Ø¶Ø¹ÙŠÙ</span></div>
  </div>

  <!-- Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„ØªØ¹Ù„Ù‘Ù… -->
  <div class="box" id="learningBox">
    <h3>Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„ØªØ¹Ù„Ù‘Ù…</h3>
    <div class="table-responsive">
      <table class="tbl" id="learningTbl">
        <thead id="learningHead">
          <tr><th>Ù…</th><th>Ø§Ù„Ù…Ø¬Ø§Ù„Ø§Øª</th><th>Ø§Ù„Ø¹Ù†Ø§ØµØ±</th><th>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø¯Ø§Ø¡</th><th>Ø¬ÙˆØ§Ù†Ø¨ Ø§Ù„ØªÙ…ÙŠÙ‘Ø²</th><th>Ø§Ø­ØªÙŠØ§Ø¬Ø§Øª Ø§Ù„ØªÙ†Ù…ÙŠØ© Ø§Ù„Ù…Ù‡Ù†ÙŠØ©</th></tr>
        </thead>
        <tbody id="rows"></tbody>
        <tfoot class="tfoot-brand"><tr><td colspan="6"></td></tr></tfoot>
      </table>
    </div>
  </div>
<!-- ============ PART 8 / 20 ============ -->
  <!-- Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø§Ù†Ø¯Ø© -->
  <div class="box" id="toolsBox">
    <h3><span>Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø§Ù†Ø¯Ø© Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„ØªØ¹Ù„Ù‘Ù…</span><small id="toolsMeta" style="margin-inline-start:6px">â€”</small></h3>
    <div class="table-responsive">
      <table class="tbl" id="toolsTbl">
        <thead id="toolsHead"><tr><th>Ù…</th><th>Ø§Ù„Ø£Ø¯ÙˆØ§Øª</th><th>Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯</th><th>Ø§Ù„ØªÙØ¹ÙŠÙ„</th><th>Ø£Ø³Ø¨Ø§Ø¨ Ø¹Ø¯Ù… Ø§Ù„ØªÙØ¹ÙŠÙ„</th></tr></thead>
        <tbody id="toolsRows"></tbody>
        <tfoot class="tfoot-brand"><tr><td colspan="5"></td></tr></tfoot>
      </table>
    </div>
  </div>

  <!-- Ø§Ù„Ø¯Ø¹Ù… -->
  <div class="box" id="supportBox">
    <h3>Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„Ù…Ù‚Ø¯Ù‘Ù… Ù„Ù„Ù…Ø¹Ù„Ù…</h3>
    <div class="support-area"><textarea id="supportArea" placeholder="ÙŠÙÙˆÙ„Ù‘ÙØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ (Ù¤ Ø£Ø³Ø·Ø±) Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª ÙˆØ§Ù„Ø£Ø¯ÙˆØ§Øªâ€¦ ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„"></textarea></div>
  </div>

  <!-- Ø§Ù„ØªÙˆÙ‚ÙŠØ¹Ø§Øª -->
  <div class="box" id="signsBox">
    <h3>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹Ø§Øª</h3>
    <div class="table-responsive">
      <table class="tbl">
        <thead><tr><th>Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</th><th>Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©</th><th>Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø© (Ø¯Ø¹Ù…)</th></tr></thead>
        <tbody>
          <tr>
            <td>
              Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…: <b id="sn1">â€”</b>
              <div style="height:1px;border-bottom:1px dashed #9fb5b1;margin:8px 24px"></div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù…
              <div style="height:8px"></div>
              Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±: <b id="pr1Name">ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</b>
              <button class="inline-pen no-print tiny" data-pen="pr1Name" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±">âœ</button>
              <div style="height:1px;border-bottom:1px dashed #9fb5b1;margin:8px 24px"></div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ±
            </td>
            <td>
              Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…: <b id="sn2">â€”</b>
              <div style="height:1px;border-bottom:1px dashed #9fb5b1;margin:8px 24px"></div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù…
              <div style="height:8px"></div>
              Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±: <b id="pr2Name">ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</b>
              <button class="inline-pen no-print tiny" data-pen="pr2Name" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±">âœ</button>
              <div style="height:1px;border-bottom:1px dashed #9fb5b1;margin:8px 24px"></div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ±
            </td>
            <td>
              Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…: <b id="sn3">â€”</b>
              <div style="height:1px;border-bottom:1px dashed #9fb5b1;margin:8px 24px"></div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù…
              <div style="height:8px"></div>
              Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±: <b id="pr3Name">ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</b>
              <button class="inline-pen no-print tiny" data-pen="pr3Name" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±">âœ</button>
              <div style="height:1px;border-bottom:1px dashed #9fb5b1;margin:8px 24px"></div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ±
            </td>
          </tr>
          <tr>
            <td>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø©: <span id="sh1">â€”</span></td>
            <td>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø©: <span id="sh2">â€”</span></td>
            <td>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø©: <span id="sh3">â€”</span></td>
          </tr>
        </tbody>
        <tfoot class="tfoot-brand"><tr><td colspan="3"></td></tr></tfoot>
      </table>
    </div>
  </div>

  <!-- Ø£Ø²Ø±Ø§Ø± Ø³ÙÙ„ÙŠØ© -->
  <div class="bottom-actions no-print">
    <button class="btn-ic" id="btnFinalize">âœ… Ø§Ø¹ØªÙ…Ø¯</button>
    <button class="btn-ic" id="btnDeleteVisit">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø²ÙŠØ§Ø±Ø©</button>
    <button class="btn-ic" id="btnClearAll">â™»ï¸ Ù…Ø³Ø­ Ø§Ù„Ø¬Ù…ÙŠØ¹</button>
  </div>

  <div class="footer-rights no-print">Ù…Ø¨Ø§Ø¯Ø±Ø© Ù…Ø¯Ø±Ø³Ø© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© Ø¨Ø§Ù„Ø®Ø¨Ø± â€” ØªÙ†ÙÙŠØ° ÙˆØªØµÙ…ÙŠÙ…: ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ â€” Ø§Ù„Ø¥ØµØ¯Ø§Ø± v02</div>
</div></div>
<!-- ============ PART 9 / 20 ============ -->
<!-- Ø§Ù„Ø­Ø§ÙØ¸Ø© -->
<div id="approvedPanel" class="no-print">
  <div class="ap-head"><h4>Ø§Ù„Ø­Ø§ÙØ¸Ø© (Ø§Ù„Ù…Ø¹Ù„Ù…ÙˆÙ† Ø§Ù„Ù…ÙØ²Ø§Ø±ÙˆÙ†)</h4><button class="ap-close" id="apClose" title="Ø¥ØºÙ„Ø§Ù‚">âœ•</button></div>
  <div id="approvedList">â€”</div>
</div>

<!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª -->
<div id="commsPanel" class="no-print">
  <div class="comms-head"><b>Ù…Ø±Ø§Ø³Ù„Ø§Øª</b><button class="ap-close" id="commsClose">âœ•</button></div>
  <div class="comms-body">
    <div class="comms-row">
      <input class="fld" id="mailTo" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
      <input class="fld" id="waPhone" placeholder="Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ø¨ØµÙŠØºØ© Ø¯ÙˆÙ„ÙŠØ© (Ù…Ø«Ø§Ù„: 9665xxxxxxx)">
      <button class="inline-pen tiny" id="editDefaults" title="Ø­ÙØ¸ ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ">âœ</button>
      <button class="btn-ic tiny" id="btnFetchFromDB" title="Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„">ğŸ”„ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡</button>
    </div>
    <textarea id="commsTxt" class="comms-preview" placeholder="Ø³ÙŠÙÙˆÙ„Ù‘Ø¯ Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù‡Ù†Ø§â€¦"></textarea>
    <div class="comms-row">
      <button class="btn-ic tiny" id="btnMakeComms">ğŸ§  ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</button>
      <button class="btn-ic tiny" id="btnCopyComms">ğŸ“‹ Ù†Ø³Ø®</button>
      <button class="btn-ic tiny" id="btnOpenWA">ğŸŸ¢ ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨</button>
      <button class="btn-ic tiny" id="btnOpenMail">âœ‰ï¸ Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯</button>
    </div>
  </div>
</div>

<!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ø­ Ø§Ù„ÙƒØ¨ÙŠØ±Ø© -->
<div id="helpPanel" class="no-print">
  <div class="help-head">
    <b>Ø´Ø±Ø­ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø©</b>
    <button class="help-close" id="helpClose">âœ•</button>
  </div>
  <div class="help-body" id="helpBody"></div>
</div>

<!-- Ù…ÙØ¹Ø§Ù„Ø¬ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ -->
<div id="importWizard">
  <div id="wizCard">
    <div id="wizHead">
      <b>Ù…ÙØ¹Ø§Ù„Ø¬ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ â€” ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† ÙˆØ§Ù„Ø£Ø¹Ù…Ø¯Ø©</b>
      <button class="wiz-close" id="wizClose">âœ•</button>
    </div>
    <div id="wizBody">
      <div id="wizRow">
        <span class="help">Ø§Ø®ØªØ± ØµÙ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†:</span>
        <select id="wizHeaderRow"></select>
        <span class="help">ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©:</span>
        <select id="mapName" class="map-select" title="Ø§Ù„Ø§Ø³Ù…"></select>
        <select id="mapId" class="map-select" title="Ø§Ù„Ù‡ÙˆÙŠØ©"></select>
        <select id="mapSpec" class="map-select" title="Ø§Ù„ØªØ®ØµØµ"></select>
        <select id="mapDeg" class="map-select" title="Ø§Ù„Ù…Ø±ØªØ¨Ø©"></select>
        <select id="mapPhone" class="map-select" title="Ø§Ù„Ø¬ÙˆØ§Ù„"></select>
        <select id="mapEmail" class="map-select" title="Ø§Ù„Ø¨Ø±ÙŠØ¯"></select>
      </div>
      <div class="help">Ù…Ø¹Ø§ÙŠÙ†Ø© (Ø£ÙˆÙ„ 30 ØµÙÙ‹Ø§):</div>
      <div class="table-responsive" style="max-height:44vh;overflow:auto;border:1px solid var(--border);border-radius:12px">
        <table id="wizTbl"><thead></thead><tbody></tbody></table>
      </div>
      <div class="help warn" id="wizHint" style="margin-top:6px"></div>
    </div>
    <div id="wizFoot">
      <button class="wiz-close" id="wizCancel">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn-ic tiny" id="wizApply">âœ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ† ÙˆØ§Ø³ØªÙŠØ±Ø§Ø¯</button>
    </div>
  </div>
</div>

<!-- Snackbar -->
<div id="snackbar"><span class="ic">âœ…</span><span id="snackText">ØªÙ…</span></div>

<!-- Ø£Ø³Ù‡Ù… ØªÙ…Ø±ÙŠØ± -->
<div class="scroll-arrows no-print">
  <button id="scrollUp" title="Ø£Ø¹Ù„Ù‰">â–²</button>
  <button id="scrollDown" title="Ø£Ø³ÙÙ„">â–¼</button>
</div>

<!-- Ø£Ø²Ø±Ø§Ø± Ø¹Ø§Ø¦Ù…Ø© -->
<div class="fab-wrap no-print" aria-label="Ø£Ø²Ø±Ø§Ø± Ø¹Ø§Ø¦Ù…Ø©">
  <button class="fab secondary" id="fabHub" title="ÙØªØ­ Ù…Ù†ØµØ© Ø§Ù„ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ">
    <span class="ic">ğŸ«</span><span class="mini">Ø§Ù„Ù…Ù†ØµØ©</span>
  </button>
  <button class="fab" id="fabHelp" title="Ø´Ø±Ø­ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…">
    <span class="ic">â“</span><span class="mini">Ø´Ø±Ø­</span>
  </button>
</div>
<!-- ============ PART 10 / 20 ============ -->
<script>
/* Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¹Ø§Ù…Ø© */
const $=s=>document.querySelector(s); const $$=s=>[...document.querySelectorAll(s)];
const dfn=(f,m=180)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>f(...a),m);}};

/* PDF.js worker */
if(window['pdfjsLib']){ pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.worker.min.js"; }

/* Header: keep aspect-ratio = image ratio (no distortion) */
function fitHeaderToImage(){
  const img = document.getElementById('hdrImg');
  const box = document.getElementById('hdrBox');
  if(!img || !box) return;
  const apply = ()=>{
    const w = img.naturalWidth || 0;
    const h = img.naturalHeight || 0;
    if(w>0 && h>0) box.style.aspectRatio = `${w} / ${h}`;
  };
  if(img.complete) apply();
  img.addEventListener('load', apply);
}

/* IndexedDB + LocalStorage */
window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB;
const hasIDB=!!window.indexedDB, LS_PREFIX='yaqfb_', DB_NAME='yaqoobi_observations', DB_VER=36, STORE='teachers';
let USE_LS=false, dbPromise=null;
const lsGet=k=>{try{return JSON.parse(localStorage.getItem(LS_PREFIX+k)||'null');}catch{return null;}};
const lsSet=(k,v)=>{try{localStorage.setItem(LS_PREFIX+k,JSON.stringify(v));}catch{}};
const lsClear=()=>{
  const rm=[];
  for(let i=0;i<localStorage.length;i++){
    const k=localStorage.key(i);
    if(k&&k.startsWith(LS_PREFIX)) rm.push(k);
  }
  rm.forEach(k=>localStorage.removeItem(k));
};

/* Ø­ÙØ¸/Ø§Ø³ØªØ±Ø¬Ø§Ø¹ (Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ… + Ø§Ù„Ù…Ø¯Ø±Ø³Ø©) */
(function initHeaderEditable(){
  const dirEl = document.getElementById('h-dir');
  const schEl = document.getElementById('h-school');
  if(!dirEl || !schEl) return;

  const d = localStorage.getItem(LS_PREFIX+'edu_dir');
  const s = localStorage.getItem(LS_PREFIX+'edu_school');
  if(d) dirEl.value = d;
  if(s) schEl.value = s;

  const save = ()=>{
    try{
      localStorage.setItem(LS_PREFIX+'edu_dir', (dirEl.value||'').trim());
      localStorage.setItem(LS_PREFIX+'edu_school', (schEl.value||'').trim());
    }catch{}
  };
  dirEl.addEventListener('input', dfn(save, 180));
  schEl.addEventListener('input', dfn(save, 180));
})();

/* Ø­ÙØ¸ Ø³ÙŠØ§Ù‚ Ø¢Ø®Ø± Ù…Ø¹Ù„Ù…/Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø© */
const LS_LAST_CTX = 'last_ctx_v2';
function saveLastContext(){
  const ctx={ key: currentKey() || fixedKey || '', activeVisit: activeVisit||1 };
  try{ localStorage.setItem(LS_PREFIX+LS_LAST_CTX, JSON.stringify(ctx)); }catch{}
}
function loadLastContext(){
  try{
    const ctx=JSON.parse(localStorage.getItem(LS_PREFIX+LS_LAST_CTX)||'null');
    if(ctx && (ctx.activeVisit===1||ctx.activeVisit===2||ctx.activeVisit===3)) activeVisit=ctx.activeVisit;
    return ctx;
  }catch{ return null; }
}

function openDB(){ if(dbPromise) return dbPromise;
  dbPromise=new Promise(res=>{
    if(!hasIDB){USE_LS=true;return res(null);}
    let req; try{req=indexedDB.open(DB_NAME,DB_VER);}catch{USE_LS=true;return res(null);}
    req.onupgradeneeded=e=>{try{
      const db=e.target.result; let os;
      if(!db.objectStoreNames.contains(STORE)){os=db.createObjectStore(STORE,{keyPath:'teacherId'});}
      else{os=req.transaction.objectStore(STORE);}
      if(os && !os.indexNames.contains('by_name')) os.createIndex('by_name','name',{unique:false});
    }catch{USE_LS=true;}};
    req.onsuccess=()=>res(req.result); req.onerror=()=>{USE_LS=true;res(null);};
  }); return dbPromise;
}
async function dbPut(rec){
  lsSet('t_'+rec.teacherId,rec);
  if(USE_LS){return true;}
  const db=await openDB(); if(!db) return true;
  return new Promise(r=>{ const tx=db.transaction(STORE,'readwrite'); tx.objectStore(STORE).put(rec).onsuccess=()=>r(true); tx.onerror=()=>r(true); });
}
async function dbGet(key){
  if(USE_LS) return lsGet('t_'+key)||null;
  const db=await openDB(); if(!db) return lsGet('t_'+key)||null;
  return new Promise(r=>{const tx=db.transaction(STORE,'readonly'); tx.objectStore(STORE).get(key).onsuccess=e=>r(e.target.result||lsGet('t_'+key)||null); tx.onerror=()=>r(lsGet('t_'+key)||null);});
}
async function dbAll(){
  if(USE_LS){
    const out=[];
    for(let i=0;i<localStorage.length;i++){
      const k=localStorage.key(i);
      if(k&&k.startsWith(LS_PREFIX+'t_')){
        const v=lsGet(k.replace(LS_PREFIX,'')); if(v) out.push(v);
      }
    }
    return out;
  }
  const db=await openDB(); if(!db) return [];
  return new Promise(r=>{
    const a=[]; const tx=db.transaction(STORE,'readonly');
    tx.objectStore(STORE).openCursor().onsuccess=e=>{const c=e.target.result; if(c){a.push(c.value); c.continue();}else r(a);};
    tx.onerror=()=>r(a);
  });
}
async function dbClear(){
  lsClear();
  if(USE_LS) return;
  const db=await openDB(); if(!db) return;
  await new Promise(r=>{ const tx=db.transaction(STORE,'readwrite'); tx.objectStore(STORE).clear().onsuccess=()=>r(true); tx.onerror=()=>r(true); });
}
async function dbDelete(key){
  try{ localStorage.removeItem(LS_PREFIX+'t_'+key); }catch{}
  if(USE_LS) return true;
  const db=await openDB(); if(!db) return true;
  return new Promise(r=>{
    const tx=db.transaction(STORE,'readwrite');
    tx.objectStore(STORE).delete(key).onsuccess=()=>r(true);
    tx.onerror=()=>r(true);
  });
}

/* Snackbar */
function snack(txt,ok=true){
  const bar=$('#snackbar');
  bar.className=ok?'snack-ok':'snack-err';
  bar.querySelector('.ic').textContent=ok?'âœ…':'âš ï¸';
  $('#snackText').textContent=txt;
  bar.style.display='block';
  clearTimeout(snack._t);
  snack._t=setTimeout(()=>bar.style.display='none',4200);
}
</script>
<!-- ============ PART 11 / 20 ============ -->
<script>
/* ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ± (Ù…ÙˆØ­Ù‘Ø¯) */
$$('[data-pen]').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const id=btn.getAttribute('data-pen'); const el=$('#'+id);
    const cur=el.textContent.trim();
    const name=prompt('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±:',cur||'');
    if(name!==null){
      ['pr1Name','pr2Name','pr3Name'].forEach(x=>$('#'+x).textContent=name);
      localStorage.setItem(LS_PREFIX+'principal', name);
    }
  });
});
(()=>{ const pr=localStorage.getItem(LS_PREFIX+'principal'); if(pr){ ['pr1Name','pr2Name','pr3Name'].forEach(id=>$('#'+id).textContent=pr); }})();

/* Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ */
function hijriNow(){
  try{
    return new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{weekday:'long',day:'numeric',month:'long',year:'numeric'}).format(new Date());
  }catch{
    return new Date().toLocaleDateString('ar-SA',{weekday:'long',day:'numeric',month:'long',year:'numeric'})||'â€”';
  }
}

/* ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… Ø¨Ø¬ÙˆØ§Ø± Ø§Ù„Ø¹Ù†ÙˆØ§Ù† + ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø®ÙÙŠ */
(function setTitleDate(){
  const d = hijriNow();
  const el = document.getElementById('todayHijri');
  if(el) el.textContent = d;
  const hidden = document.getElementById('visitDateInline');
  if(hidden && !hidden.value) hidden.value = d;
})();

/* Ø¨Ù†Ùƒ Ø§Ù„Ø¯Ø¹Ù… */
const supportBank={
  "Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØªÙ†ÙÙŠØ° Ø®Ø·Ø© Ù„Ù„ØªØ¹Ù„Ù‘Ù…":[
    {text:"Ø¥Ø¹Ù„Ø§Ù† Ù‡Ø¯Ù Ø³Ù„ÙˆÙƒÙŠ Ù„Ù„Ø­ØµÙ‘Ø© + Ø¨Ø·Ø§Ù‚Ø© Ø®Ø±ÙˆØ¬ â€” Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ù„Ø³Ø±ÙŠØ¹ â€” Ø¥ØªÙ‚Ø§Ù† â‰¥ Ù¨Ù Ùª.", src:"Ù…Ø¬Ø§Ù„: Ø§Ù„Ø®Ø·Ø©"},
    {text:"Ø´Ø±ÙŠØ­Ø© ØªÙØ¸Ù‡Ø± Ø§Ø±ØªØ¨Ø§Ø· (Ø§Ù„Ù†Ø´Ø§Ø·â†”Ø§Ù„Ù‡Ø¯Ù) â€” Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© â€” Ø§ØªØ³Ø§Ù‚ Ù¡Ù Ù Ùª.", src:"Ù…Ø¬Ø§Ù„: Ø§Ù„Ø®Ø·Ø©"},
    {text:"Ù…Ø±Ø§Ø¬Ø¹Ø© Ù†ØªÙŠØ¬ØªÙŠÙ† Ù…ØªØªØ§Ù„ÙŠØªÙŠÙ† ÙˆØ§ØªØ®Ø§Ø° Ù‚Ø±Ø§Ø± â€” ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ â€” ØªØ­Ø³Ù‘Ù† â‰¥ Ù¡Ù Ùª.", src:"Ù…Ø¬Ø§Ù„: Ø§Ù„Ø®Ø·Ø©"}
  ],
  "Ø§Ù„ØªÙ†ÙˆÙ‘Ø¹ ÙÙŠ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ³":[
    {text:"ØªØ·Ø¨ÙŠÙ‚ Â«ÙÙƒØ±â€“Ø²Ø§ÙˆØ¬â€“Ø´Ø§Ø±ÙƒÂ» Ù¦ Ø¯Ù‚Ø§Ø¦Ù‚ Ø¨Ø£Ø¯ÙˆØ§Ø± ÙˆØ§Ø¶Ø­Ø© â€” Ø£Ù†Ø´Ø·Ø© Ø¥Ø«Ø±Ø§Ø¦ÙŠØ© â€” Ù…Ø´Ø§Ø±ÙƒØ© â‰¥ Ù§Ù Ùª.", src:"Ù…Ø¬Ø§Ù„: Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª"},
    {text:"Ø³Ø¤Ø§Ù„Ø§Ù† Ù…ÙØªÙˆØ­Ø§Ù† Ù…Ø¹ ØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙØ±Øµ Ø¨Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ â€” Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ù„Ø³Ø±ÙŠØ¹ â€” Ù…Ø´Ø§Ø±ÙƒØ© â‰¥ Ù¦Ù¥Ùª.", src:"Ù…Ø¬Ø§Ù„: Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª"},
    {text:"ØªÙØ±ÙŠØ¯ Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ù†Ø³Ø®ØªÙŠÙ† Ø¹Ø¨Ø± Ø§Ù„Ù…Ù†ØµÙ‘Ø© â€” Ù…Ù†ØµØ© Ù…Ø¯Ø±Ø³ØªÙŠ â€” Ø¥ÙƒÙ…Ø§Ù„ â‰¥ Ù©Ù Ùª.", src:"Ù…Ø¬Ø§Ù„: Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª"}
  ],
  "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ":[
    {text:"ØªÙ‚Ø³ÙŠÙ… Ù¥â€“Ù¢Ù¥â€“Ù¡Ù  Ù…Ø¹ Ù…Ø¤Ù‚Ù‘Øª Ù…Ø±Ø¦ÙŠ â€” Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© â€” ÙØ§Ù‚Ø¯ â‰¤ Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†.", src:"Ù…Ø¬Ø§Ù„: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ"},
    {text:"Ø´Ø±ÙŠØ­Ø© Ù‚ÙˆØ§Ø¹Ø¯ + ØªØ¯Ø±Ù‘Ø¬ ØªØ±Ø¨ÙˆÙŠ â€” Ø§Ù†Ø®ÙØ§Ø¶ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª â‰¥ Ù¥Ù Ùª Ø®Ù„Ø§Ù„ Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ†.", src:"Ù…Ø¬Ø§Ù„: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ"},
    {text:"Ø¨Ø·Ø§Ù‚Ø§Øª Ø£Ø¯ÙˆØ§Ø± ÙˆØªÙ‚Ø±ÙŠØ± Ù…Ø¬Ù…ÙˆØ¹Ø© Ù¦Ù  Ø« â€” ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù¡Ù Ù Ùª.", src:"Ù…Ø¬Ø§Ù„: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ"}
  ],
  "ØªÙˆØ¸ÙŠÙ Ø§Ù„ØªÙ‚Ù†ÙŠØ© ÙˆÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªØ¹Ù„Ù‘Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©":[
    {text:"ÙˆØ§Ø¬Ø¨ Ù‚ØµÙŠØ± Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„Ù‡Ø¯Ù Ø¹Ø¨Ø± Ø§Ù„Ù…Ù†ØµÙ‘Ø© â€” Ø¥ÙƒÙ…Ø§Ù„ â‰¥ Ù©Ù Ùª.", src:"Ù…Ø¬Ø§Ù„: Ø§Ù„ØªÙ‚Ù†ÙŠØ©"},
    {text:"Ø¥Ø¯Ø±Ø§Ø¬ Ù…ÙˆØ±Ø¯ÙŠÙ† Ø±Ù‚Ù…ÙŠÙŠÙ† Ù…ÙˆØ«ÙˆÙ‚ÙŠÙ† â€” Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙˆØ«Ù‘Ù‚ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©.", src:"Ù…Ø¬Ø§Ù„: Ø§Ù„ØªÙ‚Ù†ÙŠØ©"},
    {text:"ØªÙ‚Ø±ÙŠØ± Ù…ØªØ¹Ø«Ø±ÙŠÙ† ÙˆØ®Ø·Ø© Ø¹Ù„Ø§Ø¬ Ù‚ØµÙŠØ±Ø© â€” ØªØ­Ø³Ù‘Ù† â‰¥ Ù¡Ù Ùª Ø®Ù„Ø§Ù„ Ø£Ø³Ø¨ÙˆØ¹.", src:"Ù…Ø¬Ø§Ù„: Ø§Ù„ØªÙ‚Ù†ÙŠØ©"}
  ],
  "ØªÙ‡ÙŠØ¦Ø© Ø¨ÙŠØ¦Ø© ØªØ¹Ù„ÙŠÙ…ÙŠØ©":[
    {text:"ØªÙ…Ù‡ÙŠØ¯ Ù…Ø±Ø¦ÙŠ Ù¦Ù â€“Ù¡Ù¢Ù  Ø« ÙŠØ±Ø¨Ø· Ø¨Ø®Ø¨Ø±Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ â€” Ù…Ø´Ø§Ø±ÙƒØ© Ø§ÙØªØªØ§Ø­ÙŠØ© â‰¥ Ù¦Ù Ùª.", src:"Ù…Ø¬Ø§Ù„: Ø§Ù„Ø¨ÙŠØ¦Ø©"},
    {text:"ØªØ¹Ø²ÙŠØ² Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ø´Ø§Ø· â€” Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© â‰¥ Ù¡Ù Ùª.", src:"Ù…Ø¬Ø§Ù„: Ø§Ù„Ø¨ÙŠØ¦Ø©"},
    {text:"Ø§Ø³ØªØ¨Ø§Ù†Ø© Ù…Ù†Ø§Ø® ØµÙÙ‘ÙŠ Ù‚ØµÙŠØ±Ø© â€” Ø±Ø¶Ø§ â‰¥ Ù¨Ù Ùª.", src:"Ù…Ø¬Ø§Ù„: Ø§Ù„Ø¨ÙŠØ¦Ø©"}
  ],
  "ØªÙ†ÙˆÙ‘Ø¹ Ø£Ø³Ø§Ù„ÙŠØ¨ ÙˆØ£Ø¯ÙˆØ§Øª Ø§Ù„ØªÙ‚ÙˆÙŠÙ…":[
    {text:"Ø³Ø¤Ø§Ù„ Ø§ÙØªØªØ§Ø­ÙŠ + Ø¨Ø·Ø§Ù‚Ø© Ø®Ø±ÙˆØ¬ Ù„Ù†ÙØ³ Ø§Ù„Ù‡Ø¯Ù â€” Ø§ØªØ³Ø§Ù‚ Ù¡Ù Ù Ùª ÙˆØªØ­Ø³Ù‘Ù† â‰¥ Ù¡Ù Ùª.", src:"Ù…Ø¬Ø§Ù„: Ø§Ù„ØªÙ‚ÙˆÙŠÙ…"},
    {text:"Ù…Ù‡Ù…Ø© Ø£Ø¯Ø§Ø¡ Ù…Ø¹ Ø³ÙÙ„Ù‘Ù… ØªÙ‚Ø¯ÙŠØ± Ù…ÙØ¹Ù„Ù† â€” Ø¥Ù†Ø¬Ø§Ø² â‰¥ Ù¨Ù Ùª.", src:"Ù…Ø¬Ø§Ù„: Ø§Ù„ØªÙ‚ÙˆÙŠÙ…"},
    {text:"Ù„ÙˆØ­Ø© Ù…Ø¤Ø´Ù‘Ø±Ø§Øª Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© (Ø¥ØªÙ‚Ø§Ù†/Ù…Ø´Ø§Ø±ÙƒØ©) â€” ØªØ­Ø¯ÙŠØ« + Ù‚Ø±Ø§Ø±.", src:"Ù…Ø¬Ø§Ù„: Ø§Ù„ØªÙ‚ÙˆÙŠÙ…"}
  ],
  "Ø§Ù„Ù†Ù…Ùˆ Ø§Ù„Ù…Ù‡Ù†ÙŠ ÙˆØ§Ù„Ø§Ù†Ø¹ÙƒØ§Ø³":[
    {text:"ØªØ£Ù…Ù‘Ù„ Â«Ù…Ø§ Ù†Ø¬Ø­/Ø³ÙŠÙƒÙˆÙ† Ø£ÙØ¶Ù„ Ù„Ùˆâ€¦Â» Ø¨Ø¹Ø¯ ÙƒÙ„ Ø¯Ø±Ø³ â€” ÙÙ‚Ø±ØªØ§Ù† Ù…ÙˆØ«Ù‘Ù‚ØªØ§Ù†.", src:"Ù…Ø¬Ø§Ù„: Ø§Ù„Ù†Ù…Ùˆ Ø§Ù„Ù…Ù‡Ù†ÙŠ"},
    {text:"Ù‡Ø¯Ù Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ù‚ØµÙŠØ± Ø¨Ø¥Ø¬Ø±Ø§Ø¡ ÙˆØ§Ø­Ø¯ ÙˆØ§Ø¶Ø­ â€” ØªØ­Ù‚Ù‘Ù‚ â‰¥ Ù‡Ø¯Ù/Ø£Ø³Ø¨ÙˆØ¹.", src:"Ù…Ø¬Ø§Ù„: Ø§Ù„Ù†Ù…Ùˆ Ø§Ù„Ù…Ù‡Ù†ÙŠ"},
    {text:"Ù…Ø´Ø§Ø±ÙƒØ© Ù…Ù…Ø§Ø±Ø³Ø© Ù†Ø§Ø¬Ø­Ø© ÙÙŠ Ù„Ù‚Ø§Ø¡ Ø§Ù„Ù…Ø§Ø¯Ø© (Ù¥ Ø¯Ù‚Ø§Ø¦Ù‚).", src:"Ù…Ø¬Ø§Ù„: Ø§Ù„Ù†Ù…Ùˆ Ø§Ù„Ù…Ù‡Ù†ÙŠ"}
  ]
};
</script>
<!-- ============ PART 12 / 20 ============ -->
<script>
/* Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ… */
const learnBank={
  "Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØªÙ†ÙÙŠØ° Ø®Ø·Ø© Ù„Ù„ØªØ¹Ù„Ù‘Ù…":{
    "ØµÙŠØ§ØºØ© Ø£Ù‡Ø¯Ø§Ù ØªØ¹Ù„Ù‘Ù… Ø³Ù„ÙˆÙƒÙŠØ© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù‚ÙŠØ§Ø³":{ok:"Ù‡Ø¯Ù ÙˆØ§Ø¶Ø­ Ø¨Ù…Ø¤Ø´Ø± Ø¥ØªÙ‚Ø§Ù† Ù…ÙØ¹Ù„Ù† ÙˆÙ…ØªØ³Ù‚ Ù…Ø¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØ§Ù„Ø²Ù…Ù†.",need:"ØªØ¯Ø±ÙŠØ¨ SMART ÙˆØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‡Ø¯Ù Ù„Ø³Ù„ÙˆÙƒÙŠ Ù‚Ø§Ø¨Ù„ Ù„Ù„Ù‚ÙŠØ§Ø³ ÙˆØ±Ø¨Ø·Ù‡ Ø¨Ø£Ø¯Ø§Ø© Ø§Ù„ØªÙ‚ÙˆÙŠÙ…."},
    "Ù…ÙˆØ§Ø¡Ù…Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØ§Ù„Ø£Ù†Ø´Ø·Ø© Ù…Ø¹ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù":{ok:"ÙƒÙ„ Ù†Ø´Ø§Ø· ÙŠØ®Ø¯Ù… Ù‡Ø¯ÙÙ‹Ø§ Ù…ÙØ¹Ù„ÙÙ†Ù‹Ø§ Ø¨ØªØ³Ù„Ø³Ù„ Ù…Ù†Ø·Ù‚ÙŠ.",need:"Ø®Ø±ÙŠØ·Ø© Â«Ù†Ø´Ø§Ø·â†”Ù‡Ø¯ÙÂ» ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØµÙ…ÙŠÙ… Ø§Ù„Ø£Ù†Ø´Ø·Ø© ØºÙŠØ± Ø§Ù„Ù…Ø­Ù‚Ù‘Ù‚Ø©."},
    "ØªÙ‡ÙŠØ¦Ø© ÙˆØ±Ø¨Ø· Ø§Ù„ØªØ¹Ù„Ù‘Ù… Ø¨Ø®Ø¨Ø±Ø§Øª Ø§Ù„Ù…ØªØ¹Ù„Ù…ÙŠÙ† Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©":{ok:"Ø³Ø¤Ø§Ù„ ØªØ´Ø®ÙŠØµÙŠ ÙˆØ£Ù…Ø«Ù„Ø© Ø³ÙŠØ§Ù‚ÙŠØ©.",need:"Ø£Ø³Ø¦Ù„Ø© ØªÙ…Ù‡ÙŠØ¯ÙŠØ© ÙØ¹Ù‘Ø§Ù„Ø© ÙˆØ³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ø±Ø¨Ø· Ø¨ØµØ±ÙŠ."}
  },
  "Ø§Ù„ØªÙ†ÙˆÙ‘Ø¹ ÙÙŠ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ³":{
    "ØªÙˆØ¸ÙŠÙ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª ØªØ¹Ù„Ù‘Ù… Ù†Ø´Ø· ÙˆÙ…ØªÙ†ÙˆÙ‘Ø¹Ø©":{ok:"ØªÙ†ÙˆÙŠØ¹ ÙØ±Ø¯ÙŠ/Ø«Ù†Ø§Ø¦ÙŠ/Ø¬Ù…Ø§Ø¹ÙŠ Ø¨Ø£Ø¯ÙˆØ§Ø± ÙˆØ²Ù…Ù†.",need:"Ø­Ù‚ÙŠØ¨Ø© Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª ÙˆØ¨Ø·Ø§Ù‚Ø§Øª Ø£Ø¯ÙˆØ§Ø± ÙˆÙ…Ø¤Ù‚Ù‘Øª."},
    "ØªÙ†Ù…ÙŠØ© Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„ØªÙÙƒÙŠØ± ÙˆØ§Ù„Ø­ÙˆØ§Ø± ÙˆØ§Ù„Ù…Ù†Ø§Ù‚Ø´Ø©":{ok:"Ø£Ø³Ø¦Ù„Ø© Ø¹Ù„ÙŠØ§ ÙˆØªÙˆØ²ÙŠØ¹ Ø¹Ø§Ø¯Ù„ ÙˆØªÙ„Ø®ÙŠØµ.",need:"Ø£Ø³Ø¦Ù„Ø© Ù…ÙØªÙˆØ­Ø© ÙˆÙ†Ù…Ø§Ø°Ø¬ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ù‚Ø§Ø´."},
    "ØªÙØ±ÙŠØ¯ Ø§Ù„Ø£Ù†Ø´Ø·Ø© ÙˆÙÙ‚ Ø§Ù„ÙØ±ÙˆÙ‚ Ø§Ù„ÙØ±Ø¯ÙŠØ©":{ok:"Ù†Ø³Ø® Ù…ØªØ¯Ø±Ø¬Ø© ÙˆØ¯Ø¹Ù… Ù…ÙˆØ¬Ù‘Ù‡ ÙˆØ¥Ø«Ø±Ø§Ø¡.",need:"ØªØµÙ…ÙŠÙ… Ù…Ù‡Ø§Ù… Ù…ØªÙ…Ø§ÙŠØ²Ø© Ù‚ØµÙŠØ±Ø© ÙˆØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø£Ø«Ø±."}
  },
  "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ":{
    "ØªÙ†Ø¸ÙŠÙ… Ø§Ù„ÙˆÙ‚Øª ÙˆØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø­ØµØ© ÙˆØ§Ù†ØªÙ‚Ø§Ù„Ø§Øª Ø§Ù„Ø£Ù†Ø´Ø·Ø©":{ok:"ØªÙ‡ÙŠØ¦Ø©â€“ØªØ¹Ù„Ù‘Ù…â€“ØªÙ‚ÙˆÙŠÙ… Ù…Ø¹ Ù…Ø¤Ù‚Ù‘Øª.",need:"Ø®Ø· Ø²Ù…Ù†ÙŠ ÙˆØªÙ‚Ù„ÙŠÙ„ ÙØ§Ù‚Ø¯ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„."},
    "ÙˆØ¶ÙˆØ­ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ÙˆØ§Ù„ØªØ¯Ø±Ù‘Ø¬ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø³Ù„ÙˆÙƒ":{ok:"Ù‚ÙˆØ§Ø¹Ø¯ Ù…Ø¹Ù„Ù†Ø© ÙˆØ§Ø³ØªØ¬Ø§Ø¨Ø© Ù…ØªØ¯Ø±Ù‘Ø¬Ø©.",need:"Ù…ÙŠØ«Ø§Ù‚ ØµÙÙ‘ÙŠ ÙˆØ§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª ØªØ¹Ø²ÙŠØ²."},
    "ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª/Ø§Ù„Ø­Ø±ÙƒØ© Ø§Ù„ØµÙÙŠØ©":{ok:"Ø£Ø¯ÙˆØ§Ø± ÙˆØ§Ø¶Ø­Ø© ÙˆØ­Ø±ÙƒØ© Ù…Ù†Ø¸Ù…Ø©.",need:"Ø¨Ø·Ø§Ù‚Ø§Øª Ø£Ø¯ÙˆØ§Ø± ÙˆÙ…Ø³Ø§Ø±Ø§Øª Ø­Ø±ÙƒØ©."}
  },
  "ØªÙˆØ¸ÙŠÙ Ø§Ù„ØªÙ‚Ù†ÙŠØ© ÙˆÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªØ¹Ù„Ù‘Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©":{
    "ØªÙˆØ¸ÙŠÙ Ø§Ù„Ù…Ù†ØµØ§Øª ÙˆØ§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ø¨Ù…Ø§ ÙŠØ®Ø¯Ù… Ø§Ù„Ù‡Ø¯Ù":{ok:"Ù†Ø´Ø§Ø· Ø±Ù‚Ù…ÙŠ ÙŠÙ‚ÙŠØ³ Ø§Ù„Ù‡Ø¯Ù ÙˆØªØªØ¨Ù‘Ø¹ ØªÙ‚Ø¯Ù‘Ù….",need:"Ø§Ø®ØªÙŠØ§Ø± Ø£Ø¯Ø§Ø© Ù…Ù†Ø§Ø³Ø¨Ø© ÙˆÙ†Ø´Ø±/ØªÙ‚Ø§Ø±ÙŠØ±."},
    "Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© ÙˆØ­Ù…Ø§ÙŠØ© Ø§Ù„Ø®ØµÙˆØµÙŠØ©":{ok:"ØªØ°ÙƒÙŠØ± Ø£Ù…Ø§Ù† ÙˆÙ…Ù†ØµØ§Øª Ù…Ø¹ØªÙ…Ø¯Ø©.",need:"Ù‚Ø§Ø¦Ù…Ø© ØªØ­Ù‚Ù‚ ÙˆØ­Ù…Ø§ÙŠØ© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª."}
  },
  "ØªÙ‡ÙŠØ¦Ø© Ø¨ÙŠØ¦Ø© ØªØ¹Ù„ÙŠÙ…ÙŠØ©":{
    "Ù…Ù†Ø§Ø® ØªØ¹Ù„Ù‘Ù… Ø¯Ø§Ø¹Ù… ÙˆØ§Ø­ØªØ±Ø§Ù… Ù…ØªØ¨Ø§Ø¯Ù„":{ok:"ØªØ¹Ø²ÙŠØ² Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„Ø£Ø¯Ø§Ø¡.",need:"ØªØ¹Ø²ÙŠØ² ØºÙŠØ± Ù…Ø§Ø¯ÙŠ ÙˆØ¨Ù†Ø§Ø¡ Ø§Ù„Ø«Ù‚Ø©."},
    "ØªÙ‡ÙŠØ¦Ø© Ù†ÙØ³ÙŠØ© ÙˆØ§Ø¬ØªÙ…Ø§Ø¹ÙŠØ© Ù…Ù„Ø§Ø¦Ù…Ø© Ù„Ù„Ù…Ø±Ø­Ù„Ø©":{ok:"ÙƒØ³Ø± Ø¬Ù„ÙŠØ¯ ÙˆØ¥Ø´Ø§Ø±Ø§Øª ÙˆØ§Ø¶Ø­Ø©.",need:"ØªÙƒÙŠÙŠÙ Ø£Ù†Ø´Ø·Ø© Ù‚ØµÙŠØ±Ø©."},
    "Ø¥Ø«Ø§Ø±Ø© Ø§Ù„Ø¯Ø§ÙØ¹ÙŠØ© ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ©":{ok:"Ù…Ù‡Ø§Ù… Ø°Ø§Øª Ù…Ø¹Ù†Ù‰ ÙˆØªØªØ¨Ø¹ Ù…Ø´Ø§Ø±ÙƒØ©.",need:"Ù…Ø­ÙÙ‘Ø²Ø§Øª ÙˆØ±Ø¨Ø· Ø¨Ø§Ù„ØºØ§ÙŠØ©."}
  },
  "ØªÙ†ÙˆÙ‘Ø¹ Ø£Ø³Ø§Ù„ÙŠØ¨ ÙˆØ£Ø¯ÙˆØ§Øª Ø§Ù„ØªÙ‚ÙˆÙŠÙ…":{
    "ØªÙ‚ÙˆÙŠÙ… Ù‚Ø¨Ù„ÙŠ ØªØ´Ø®ÙŠØµÙŠ":{ok:"Ø³Ø¤Ø§Ù„ Ø§ÙØªØªØ§Ø­ÙŠ ÙˆØªÙˆØ¸ÙŠÙ Ù…Ø¨Ø§Ø´Ø±.",need:"Ø¨Ù†ÙˆÙƒ Ø£Ø³Ø¦Ù„Ø© ÙˆÙ…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø£Ø¯Ø§Ø©."},
    "ØªÙ‚ÙˆÙŠÙ… Ø¨Ù†Ø§Ø¦ÙŠ Ù…Ø³ØªÙ…Ø±":{ok:"Ø£Ø³Ø¦Ù„Ø© ÙÙˆØ±ÙŠØ© + Ø¨Ø·Ø§Ù‚Ø© Ø®Ø±ÙˆØ¬.",need:"Ø£Ø¯ÙˆØ§Øª Ù‚ØµÙŠØ±Ø© ÙˆØªØ¹Ù„ÙŠÙ‚Ø§Øª Ù†ÙˆØ¹ÙŠØ©."},
    "ØªÙ‚ÙˆÙŠÙ… Ø®ØªØ§Ù…ÙŠ Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„Ø£Ù‡Ø¯Ø§Ù":{ok:"Ù…Ù‡Ù…Ø© Ø£Ø¯Ø§Ø¡ Ù…Ø¹ Rubric.",need:"Ù…Ù‡Ø§Ù… Ø£ØµÙŠÙ„Ø© ÙˆRubrics."},
    "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØªÙˆØ¸ÙŠÙ Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø±Ø§Ø¬Ø¹Ø©":{ok:"Ù…Ø¤Ø´Ø±Ø§Øª ÙˆÙ‚Ø±Ø§Ø±Ø§Øª ØªØ­Ø³ÙŠÙ†.",need:"ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ®Ø·Ø· Ù‚ØµÙŠØ±Ø©."}
  },
  "Ø§Ù„Ù†Ù…Ùˆ Ø§Ù„Ù…Ù‡Ù†ÙŠ ÙˆØ§Ù„Ø§Ù†Ø¹ÙƒØ§Ø³":{
    "ØªØ£Ù…Ù‘Ù„ Ù…Ù‡Ù†ÙŠ ÙˆØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯":{ok:"ØªØ£Ù…Ù‘Ù„ Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø±Ø³ ÙˆØ±Ø¨Ø· Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯.",need:"WWW/EBI ÙˆØªÙ†Ø¸ÙŠÙ… Ù…Ù„Ù."},
    "Ø®Ø·Ø© ØªØ­Ø³ÙŠÙ† Ù‚ØµÙŠØ±Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù‚ÙŠØ§Ø³ ÙˆÙ…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù…Ø§Ø±Ø³Ø§Øª":{ok:"Ù‡Ø¯Ù Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ø¨Ù…Ø¤Ø´Ø± ÙˆØ¥Ø¬Ø±Ø§Ø¡.",need:"ØµÙŠØ§ØºØ© Ø£Ù‡Ø¯Ø§Ù ÙˆØ¯ÙˆØ±Ø§Øª Ø³Ø±ÙŠØ¹Ø©."}
  }
};
const fields=Object.keys(learnBank).map(d=>({name:d,items:Object.keys(learnBank[d]).map(k=>[k,""])}));

/* Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø§Ù†Ø¯Ø© */
const toolsData=[
  {title:'ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ØªØ¹Ù„Ù…ÙŠÙ†',proof:'Ù…Ø¤Ø´Ø±Ø§Øª Ù„Ù„Ø¥ØªÙ‚Ø§Ù† ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒØ©.'},
  {title:'ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¹Ù„Ù…ÙŠØ©',proof:'Ø®Ø·Ø© ØªØ­Ø³ÙŠÙ† Ù…Ø¨Ù†ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ù„ÙŠÙ„.'},
  {title:'ØªÙØ¹ÙŠÙ„ Ù…Ù†ØµØ© Ù…Ø¯Ø±Ø³ØªÙŠ ÙˆÙ…ØªØ§Ø¨Ø¹ØªÙ‡Ø§',proof:'Ù†Ø´Ø± Ø§Ù„Ù…Ù‡Ø§Ù… ÙˆØ±ØµØ¯ Ø§Ù„ØªÙ‚Ø¯Ù‘Ù….'},
  {title:'ØªÙØ¹ÙŠÙ„ ÙƒØªØ§Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨',proof:'ØªÙˆØ¸ÙŠÙ Ø§Ù„ÙƒØªØ§Ø¨ Ø¨Ø§Ù„Ø£Ù‡Ø¯Ø§Ù.'},
  {title:'Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ù„Ø³Ø±ÙŠØ¹',proof:'Ø£Ø³Ø¦Ù„Ø© ÙÙˆØ±ÙŠØ©.'},
  {title:'Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…ÙŠØ© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©',proof:'Ø´Ø±Ø§Ø¦Ø­ Ù…Ù†Ø¸Ù‘Ù…Ø© ÙˆØªÙØ§Ø¹Ù„ÙŠØ©.'},
  {title:'Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ø§Ù„Ø¥Ø«Ø±Ø§Ø¦ÙŠØ©',proof:'Ù…Ù‡Ø§Ù… Ø±Ù‚Ù…ÙŠØ© Ù‚ØµÙŠØ±Ø©.'},
  {title:'Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø±Ø¦ÙŠ ÙˆØ§Ù„Ù…Ø­Ø§ÙƒØ§Ø©',proof:'ÙÙŠØ¯ÙŠÙˆ/Ù…Ø­Ø§ÙƒØ§Ø© Ù„Ù„Ù…ÙØ§Ù‡ÙŠÙ….'},
  {title:'Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹ Ø§Ù„Ù…Ù‡Ù†ÙŠ',proof:'Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù…Ø§Ø±Ø³Ø§Øª.'},
  {title:'Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±',proof:'ØªÙˆØ§ØµÙ„ Ø¯Ø§Ø¹Ù… Ù„ØªØ¹Ù„Ù‘Ù… Ø§Ù„Ø·Ø§Ù„Ø¨.'}
];

function zeroMatrix(){ return fields.map(f=>Array(f.items.length).fill(0)); }
function clone(o){ return JSON.parse(JSON.stringify(o)); }
let store={1:zeroMatrix(),2:zeroMatrix(),3:zeroMatrix()}, activeVisit=1, loadedRecord=null, fixedKey=null;

/* Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª */
function levelLabel(p){ return p>=80?'Ù…ØªÙ…ÙŠØ²':(p>=50?'Ù…ØªÙˆØ³Ø·':'Ø¶Ø¹ÙŠÙ'); }
function levelColor(p){ return p>=80?'#16a34a':(p>=50?'#f59e0b':'#ef4444'); }
function visitScore(v){
  const area=store[v].flat().filter(Boolean);
  const areaPct=area.length? (area.reduce((a,b)=>a+b,0)/(area.length*3))*85:0;
  const states=(loadedRecord?.visits?.[v]?.draft?.tools)||getToolsStateFromUI();
  const tScaled=((states.reduce((a,b)=>a+(b===2?1:(b===1?0.5:0)),0)/(states.length||1))*15);
  return Math.min(100,Math.round(areaPct+tScaled));
}
function setDonut(v,p){
  const svg=$('#v'+v), ring=svg.querySelector('.ring'), txt=$('#v'+v+'t');
  const c=2*Math.PI*50; const per=Math.max(0,Math.min(100,Math.round(p||0)));
  ring.setAttribute('stroke-dasharray',`${(per/100)*c} ${c}`);
  ring.setAttribute('stroke',levelColor(per));
  txt.textContent=levelLabel(per);
}
function setVisitMeter(){
  const p=visitScore(activeVisit);
  $('#hThumb').style.left=p+'%';
  $('#kpiPct').textContent=levelLabel(p);
  $('#hThumb').style.borderColor=levelColor(p);
}
function setGlobalMeter(){
  const p1=visitScore(1),p2=visitScore(2),p3=visitScore(3);
  let g=0;
  if(p1<50){
    const a=[p1,p2,p3].filter(x=>x>0);
    g=a.length?Math.round(a.reduce((x,y)=>x+y,0)/a.length):0;
  }else{
    const a=[p1,p2].filter(x=>x>0);
    g=a.length?Math.round(a.reduce((x,y)=>x+y,0)/a.length):0;
  }
  $('#globalThumb').style.left=g+'%';
  const span=$('#globalPctInline');
  span.textContent=levelLabel(g);
  span.className='globalInline '+(g>=80?'good':(g>=50?'mid':'bad'));
}
</script>
<!-- ============ PART 13 / 20 ============ -->
<script>
/* Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
function buildLearning(){
  const tb=$('#rows'); tb.innerHTML='';
  fields.forEach((f,fi)=>{
    f.items.forEach((pair,ii)=>{
      const [label]=pair;
      const tr=document.createElement('tr'); tr.className=ii===0?'field-start':'field-row';
      if(ii===0){
        tr.innerHTML+=`<td rowspan="${f.items.length}" class="seq">${fi+1}</td><td rowspan="${f.items.length}" class="domain-cell">${f.name}</td>`;
      }
      tr.innerHTML+=`<td class="item-cell"><span class="item-title">${label}</span></td><td><div class="level"><button data-v="1">Ø¶Ø¹ÙŠÙ</button><button data-v="2">Ù…ØªÙˆØ³Ø·</button><button data-v="3">Ù…ØªÙ…ÙŠØ²</button></div></td><td class="ok-td">â€”</td><td class="need-td">â€”</td>`;
      tb.appendChild(tr);

      const btns=[...tr.querySelectorAll('.level button')];
      const savedVal=store[activeVisit][fi][ii];
      if(savedVal>0){
        btns.forEach(b=>b.classList.toggle('active',Number(b.dataset.v)===savedVal));
        applyBNK(tr,fi,label,savedVal);
      }
      btns.forEach(b=>b.addEventListener('click',()=>{
        btns.forEach(x=>x.classList.remove('active')); b.classList.add('active');
        const v=Number(b.dataset.v);
        store[activeVisit][fi][ii]=v;
        applyBNK(tr,fi,label,v);
        saveDraft();
        calcAll();
      }));
    });
  });
}
function applyBNK(tr,fi,label,lvl){
  const ok=tr.querySelector('.ok-td'), need=tr.querySelector('.need-td');
  const dom=fields[fi].name;
  const bank=learnBank[dom]?.[label];
  ok.textContent = (lvl===3 && bank)? bank.ok : (lvl===2? 'ØªÙ‚Ø¯Ù‘Ù… Ù…Ù„Ø­ÙˆØ¸ ÙŠØ­ØªØ§Ø¬ ØªØ«Ø¨ÙŠØªÙ‹Ø§.' : 'â€”');
  need.textContent = (lvl<=2 && bank)? bank.need : 'â€”';
}

function buildTools(){
  const tb=$('#toolsRows'); tb.innerHTML='';
  toolsData.forEach((t,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="seq">${i+1}</td>
      <td><div class="tool-title">${t.title}</div><div class="tool-brief">${t.proof||''}</div></td>
      <td class="td-proof"><input type="checkbox" title="Ø´Ø§Ù‡Ø¯Øª Ø§Ù„Ø¯Ù„ÙŠÙ„ØŸ"></td>
      <td><div class="level tool-level"><button data-v="1" title="ØºÙŠØ± Ù…ÙÙØ¹Ù„">ØºÙŠØ± Ù…ÙÙØ¹Ù„</button><button data-v="2" title="Ø¥Ù„Ù‰ Ø­Ø¯ Ù…Ø§">Ø¥Ù„Ù‰ Ø­Ø¯ Ù…Ø§</button><button data-v="3" title="Ù…ÙÙØ¹Ù„">Ù…ÙÙØ¹Ù„</button></div></td>
      <td><textarea class="tool-reason" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¨Ø¨ Ø¹Ù†Ø¯ Ø¹Ø¯Ù… Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø£Ùˆ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¬Ø²Ø¦ÙŠâ€¦"></textarea></td>`;
    tb.appendChild(tr);

    const set=tr.querySelector('.tool-level');
    set.querySelectorAll('button').forEach(btn=>{
      btn.addEventListener('click',()=>{
        set.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const v=Number(btn.dataset.v);
        const reason=tr.querySelector('.tool-reason');
        reason.disabled=(v===3);
        if(v===3) reason.value='';
        saveDraft();
        calcAll();
      });
    });
    tr.querySelector('.tool-reason').addEventListener('input',dfn(()=>{saveDraft();},150));
  });
  updateToolsSummary();
}
function getToolsStateFromUI(){
  return [...document.querySelectorAll('.tool-level')].map(set=>{
    const act=set.querySelector('button.active');
    if(!act) return null;
    const d=Number(act.dataset.v);
    return d===3?2:(d===2?1:0);
  });
}
function setToolsStateToUI(arr){
  const sets=[...document.querySelectorAll('.tool-level')];
  sets.forEach((set,i)=>{
    set.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
    const s=(arr&&typeof arr[i]!=='undefined')?arr[i]:null;
    if(s===0||s===1||s===2){
      const v=s===2?3:(s===1?2:1);
      (set.querySelector(`button[data-v="${v}"]`)||{}).classList?.add('active');
      const reason=set.parentElement.nextElementSibling.querySelector('.tool-reason');
      reason.disabled=(s===2);
      if(s===2) reason.value='';
    }
  });
  updateToolsSummary();
}
function getToolReasonsFromUI(){ return [...document.querySelectorAll('.tool-reason')].map(t=>(t.value||'').trim()); }
function updateToolsSummary(){
  const st=getToolsStateFromUI();
  let u=0;
  st.forEach(v=>{ if(v==null) u++; });
  $('#toolsMeta').textContent=`${toolsData.length} Ø£Ø¯Ø§Ø© â€¢ Ù…Ø­Ø¯Ø¯: ${toolsData.length-u} â€¢ ØºÙŠØ± Ù…Ø­Ø¯Ø¯: ${u}`;
}
</script>
<!-- ============ PART 14 / 20 ============ -->
<script>
/* Ø²ÙŠØ§Ø±Ø§Øª + ØªÙˆØ§Ø±ÙŠØ® */
['1','2','3'].forEach(v=>{
  $('#v'+v).addEventListener('click',()=>switchVisit(Number(v)));
  $('#v'+v+'h').addEventListener('click',()=>{ setVisitDate(Number(v)); saveDraft(); });
});
function setVisitDate(v){
  const d=hijriNow();
  $('#v'+v+'h').textContent=d;
  $('#sh'+v).textContent=d;
  const hidden=$('#visitDateInline');
  if(hidden) hidden.value=d;
  const el=$('#todayHijri'); if(el) el.textContent = d;
}

function currentKey(){
  if(fixedKey) return fixedKey;
  const id=($('#tId').value||'').replace(/\D+/g,'');
  if(/^\d{10}$/.test(id)) return id;
  const name=($('#tName').value||'').trim();
  return name?('name:'+name):'';
}

function switchVisit(v){
  if(v===3){
    const p1=visitScore(1), p2=visitScore(2);
    const allowed=(p1<50 || p2<50);
    if(!allowed){ snack('Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ø¯Ø¹Ù… (Ø¶Ø¹Ù Ø§Ù„Ù…Ø¤Ø´Ø±).',false); return; }
  }
  activeVisit=v;
  buildLearning();
  buildTools();
  renderFromRecord();
  setDonut(1,visitScore(1)); setDonut(2,visitScore(2)); setDonut(3,visitScore(3));
  setVisitMeter();
  setGlobalMeter();
  saveLastContext();
}

/* Ø­ÙØ¸/ØªØ­Ù…ÙŠÙ„ */
function zeroSupport(){ return {ratings:zeroMatrix(),tools:[],reasons:[],support:[],supportDetailed:[],date:''}; }
async function ensureRecord(){
  const key=currentKey();
  if(!key) return null;

  let rec=await dbGet(key);
  if(!rec){
    rec={
      teacherId:key,
      name:($('#tName').value||'').trim(),
      nationalId:($('#tId').value||'').replace(/\D+/g,'').slice(0,10),
      spec:($('#tSpec').value||'').trim(),
      degree:($('#degree').value||'').trim(),
      class:($('#class').value||'').trim(),
      lesson:($('#lesson').value||'').trim(),
      phone: localStorage.getItem(LS_PREFIX+'waPhone') || '9665',
      email: localStorage.getItem(LS_PREFIX+'mailTo') || 'example@school.edu.sa',
      visits:{1:{finalized:false,draft:zeroSupport()},2:{finalized:false,draft:zeroSupport()},3:{finalized:false,draft:zeroSupport()}}
    };
  }
  loadedRecord=rec;
  fixedKey=rec.teacherId;
  saveLastContext();
  return rec;
}
</script>
<!-- ============ PART 15 / 20 ============ -->
<script>
/* Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¯Ø¹Ù… (Ù¤ Ø£Ø³Ø·Ø±) */
function supportFromLogicDetailed(){
  const worst=[];
  fields.forEach((f,fi)=>{
    const arr=(store[activeVisit][fi]||[]).filter(v=>v>0);
    const avg=arr.length?arr.reduce((a,b)=>a+b,0)/arr.length:0;
    worst.push({fi,avg});
  });
  worst.sort((a,b)=>a.avg-b.avg);

  const out=[];
  function pickFor(fi){
    const dom=fields[fi].name;
    const scores=store[activeVisit][fi]||[];
    const hasWeak=scores.some(v=>v===1), hasMid=scores.some(v=>v===2);
    const bank=supportBank[dom]||[];
    if(hasWeak) return bank[0];
    if(hasMid) return bank[1]||bank[0];
    return bank[2]||bank[0];
  }
  if(worst[0]){ const l=pickFor(worst[0].fi); if(l) out.push(l); }
  if(worst[1]){ const l=pickFor(worst[1].fi); if(l) out.push(l); }

  const states=[...document.querySelectorAll('.tool-level')].map(set=>{
    const act=set.querySelector('button.active'); return act?Number(act.dataset.v):0;
  });
  const reasons=[...document.querySelectorAll('.tool-reason')].map(e=>e.value.trim());

  states.map((v,i)=>({i,v})).sort((a,b)=>a.v-b.v).slice(0,2).forEach(({i,v})=>{
    const t=(toolsData[i]||{}).title||'Ø£Ø¯Ø§Ø©';
    let text=v>=3?`ØªÙˆØ³ÙŠØ¹ ØªÙØ¹ÙŠÙ„ ${t} Ø¹Ø¨Ø± Ù‚Ø§Ù„Ø¨ Ø¬Ø§Ù‡Ø².`:v===2?`ØªØ±Ù‚ÙŠØ© ${t} Ø¨Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø§Ø¦ÙŠ ÙÙˆØ±ÙŠ.`:`Ø¨Ø¯Ø¡ ØªÙØ¹ÙŠÙ„ ${t} Ø¨ØªØ¬Ø±Ø¨Ø© Ù‚ØµÙŠØ±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­ØµØ©.`;
    const why=reasons[i]; if(why) text+=` (Ù…Ø§Ù†Ø¹: ${why.slice(0,40)})`;
    out.push({text,src:`Ø£Ø¯Ø§Ø©: ${t}`});
  });

  return out.filter(Boolean).slice(0,4);
}

function ensureSupport(){
  const area = $('#supportArea');
  const currentTxt=(area.value||'').trim();
  const lines=currentTxt? currentTxt.split('\n').map(s=>s.trim()).filter(Boolean) : [];
  let detailed=[];

  if(lines.length>=4){
    detailed=lines.slice(0,4).map(t=>({text:t,src:'ÙŠØ¯ÙˆÙŠ'}));
  }else{
    const auto=supportFromLogicDetailed();
    if(lines.length>0){
      detailed=[...lines.map(t=>({text:t,src:'ÙŠØ¯ÙˆÙŠ'})), ...auto.slice(lines.length)].slice(0,4);
    }else{
      detailed=auto.slice(0,4);
    }
    area.value=detailed.map(x=>x.text).join('\n');
  }
  return detailed;
}

async function saveDraft(){
  const rec=await ensureRecord(); if(!rec) return;
  const v=activeVisit;

  rec.name=$('#tName').value.trim();
  rec.nationalId=$('#tId').value.replace(/\D+/g,'').slice(0,10);
  rec.spec=$('#tSpec').value.trim();
  rec.degree=$('#degree').value.trim();
  rec.class=$('#class').value.trim();
  rec.lesson=$('#lesson').value.trim();

  rec.phone = (rec.phone || (localStorage.getItem(LS_PREFIX+'waPhone')||'')).trim();
  rec.email = (rec.email || (localStorage.getItem(LS_PREFIX+'mailTo')||'')).trim();

  rec.visits[v]??={finalized:false,draft:{}};
  rec.visits[v].draft.ratings=clone(store[v]);
  rec.visits[v].draft.tools=getToolsStateFromUI();
  rec.visits[v].draft.reasons=getToolReasonsFromUI();

  const detailed=ensureSupport();
  rec.visits[v].draft.supportDetailed=detailed;
  rec.visits[v].draft.support=detailed.map(x=>x.text);
  rec.visits[v].draft.date=$('#v'+v+'h').textContent||'';

  await dbPut(rec);
  loadedRecord=rec;

  setDonut(1,visitScore(1)); setDonut(2,visitScore(2)); setDonut(3,visitScore(3));
  setVisitMeter(); setGlobalMeter();
  saveLastContext();
}
</script>
<!-- ============ PART 16 / 20 ============ -->
<script>
async function renderFromRecord(){
  const rec=await ensureRecord(); if(!rec) return;

  store={1:zeroMatrix(),2:zeroMatrix(),3:zeroMatrix()};
  [1,2,3].forEach(v=>{
    const snap=rec.visits?.[v]?.draft;
    if(snap?.ratings) store[v]=clone(snap.ratings);
    if(snap?.date){
      $('#v'+v+'h').textContent=snap.date;
      $('#sh'+v).textContent=snap.date;
      $('#visitDateInline').value = snap.date;
      const el=$('#todayHijri'); if(el) el.textContent = snap.date;
    }
  });

  buildLearning();
  buildTools();

  const arr=rec.visits?.[activeVisit]?.draft?.tools||[];
  const reasons=rec.visits?.[activeVisit]?.draft?.reasons||[];
  setToolsStateToUI(arr);

  [...document.querySelectorAll('.tool-reason')].forEach((ta,i)=>{
    ta.value=(reasons&&typeof reasons[i]!=='undefined')?reasons[i]:'';
    ta.disabled=(arr&&arr[i]===2);
  });

  const det=rec.visits?.[activeVisit]?.draft?.supportDetailed||[];
  if(det.length>=4){
    $('#supportArea').value=det.map(x=>x.text).join('\n');
  }else{
    ensureSupport();
  }

  syncSignNames();
  const pr=localStorage.getItem(LS_PREFIX+'principal');
  if(pr){ ['pr1Name','pr2Name','pr3Name'].forEach(id=>$('#'+id).textContent=pr); }

  // Ù…Ø²Ø§Ù…Ù†Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø±Ø§Ø³Ù„Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø¬Ù„/Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
  if(rec.email) $('#mailTo').value = rec.email;
  if(rec.phone) $('#waPhone').value = rec.phone;

  setDonut(1,visitScore(1)); setDonut(2,visitScore(2)); setDonut(3,visitScore(3));
  setVisitMeter(); setGlobalMeter();
}

/* Ø£Ø¯ÙˆØ§Øª ØªÙ†Ø¸ÙŠÙ/ØªØ­Ù„ÙŠÙ„ */
function arNorm(s){
  if(!s) return '';
  const diac=/[\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06ED]/g;
  const tatweel=/\u0640/g;
  const arabNums={'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9'};
  return String(s).replace(diac,'').replace(tatweel,'')
    .replace(/[0-9\u0660-\u0669]/g,ch=>arabNums[ch]??ch)
    .replace(/\s+/g,' ').trim().toLowerCase();
}
function digitsOnly(s){
  if(s==null) return '';
  const arab='Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©';
  return String(s).replace(/[^\d\u0660-\u0669]/g,'')
    .replace(/[\u0660-\u0669]/g, d=> String(arab.indexOf(d)));
}
function likelyId(val){
  if(val==null) return '';
  let s=String(val).trim();
  if(/e\+/i.test(s)){ const num=Number(s); if(Number.isFinite(num)) s=String(Math.round(num)); }
  s=digitsOnly(s); if(s.length>=10) s=s.slice(0,10);
  return (s.length===10)? s : '';
}
function findHeaderRow(rows){
  const aliasName=['Ø§Ù„Ø§Ø³Ù…','Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…','Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù','name','Ø§Ø³Ù…'];
  for(let r=0;r<Math.min(30,rows.length);r++){
    const normRow=(rows[r]||[]).map(v=>arNorm(v));
    const hasName = normRow.some(h=> aliasName.some(a=>h.includes(a) || a.includes(h)));
    if(hasName && (normRow.filter(x=>x).length>=2)) return r;
  }
  return -1;
}
</script>
<!-- ============ PART 17 / 20 ============ -->
<script>
/* PDF â†’ rows */
async function pdfToRows(file){
  const buf=new Uint8Array(await file.arrayBuffer());
  const pdf=await pdfjsLib.getDocument({data:buf}).promise;
  const rows=[];
  for(let p=1;p<=pdf.numPages;p++){
    const page=await pdf.getPage(p);
    const content=await page.getTextContent();
    const lines=[];
    content.items.forEach(it=>lines.push(String(it.str||'')));
    const txt=lines.join(' ').replace(/\s+/g,' ').trim();
    const arr=txt.split(/[\r\n]+/).filter(Boolean);
    (arr.length?arr:[txt]).forEach(l=>{
      const parts = String(l).split(/\t|;|,| {2,}/).map(x=>x.trim());
      if(parts.some(c=>c)) rows.push(parts);
    });
  }
  return rows;
}

/* File â†’ rows */
async function fileToRows(file){
  const ext=(file.name.split('.').pop()||'').toLowerCase();
  if(ext==='pdf') return await pdfToRows(file);
  const buf=await file.arrayBuffer();
  const wb=XLSX.read(buf,{type:'array',raw:false,cellDates:true});
  let sh=null;
  for(const name of wb.SheetNames){
    const candidate=wb.Sheets[name];
    const test=XLSX.utils.sheet_to_json(candidate,{header:1,defval:''});
    if(test && test.length && test.some(r=>r.some(c=>String(c).trim()!==''))){ sh=candidate; break; }
  }
  if(!sh) return [];
  return XLSX.utils.sheet_to_json(sh,{header:1,defval:''});
}

/* Ù…ÙØ¹Ø§Ù„Ø¬ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ */
const wiz = { rows:[], headers:[], headerRow:0, map:{name:'',id:'',spec:'',deg:'',phone:'',email:''} };

function fillSelectWithColumns(sel, headers){
  sel.innerHTML = '<option value="">â€” ØºÙŠØ± Ù…Ø¹ÙŠÙ‘Ù† â€”</option>' +
    headers.map((h,i)=>`<option value="${i}">${h||('Ø¹Ù…ÙˆØ¯ '+(i+1))}</option>`).join('');
}
function renderWizardTable(){
  const thead=$('#wizTbl thead'), tbody=$('#wizTbl tbody');
  thead.innerHTML = '<tr>'+ wiz.headers.map(h=>`<th>${h||'â€”'}</th>`).join('') + '</tr>';
  const data = wiz.rows.slice(wiz.headerRow+1, wiz.headerRow+1+30);
  tbody.innerHTML = data.map(r=>'<tr>'+ r.map(c=>`<td>${String(c||'').toString().replace(/</g,'&lt;')}</td>`).join('') +'</tr>').join('');
}
function openWizard(rows, forcedHeaderRow = null){
  wiz.rows = rows.slice();
  let hri = (forcedHeaderRow!=null) ? forcedHeaderRow : findHeaderRow(rows);
  if(hri<0) hri = 0;
  wiz.headerRow = hri;
  wiz.headers = (rows[hri]||[]).map(x=>String(x||'').trim());

  const hdrSel = $('#wizHeaderRow');
  hdrSel.innerHTML = rows.slice(0,Math.min(30,rows.length))
    .map((r,idx)=>`<option value="${idx}" ${idx===hri?'selected':''}>Ø§Ù„ØµÙ ${idx+1}</option>`).join('');
  hdrSel.onchange = ()=> openWizard(rows, parseInt(hdrSel.value,10));

  const Hnorm = wiz.headers.map(h=>arNorm(h));
  function findAlias(arr){
    for(const al of arr){
      const i=Hnorm.findIndex(h=> h.includes(al)||al.includes(h));
      if(i>-1) return i;
    }
    return '';
  }
  wiz.map = {
    name: String(findAlias(['Ø§Ù„Ø§Ø³Ù…','Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…','Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù','name','Ø§Ø³Ù…'])),
    id:   String(findAlias(['Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©','Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ','Ù‡ÙˆÙŠØ©','Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„','id','Ø§Ù„Ù‡ÙˆÙŠØ©'])),
    spec: String(findAlias(['Ø§Ù„ØªØ®ØµØµ','Ø§Ù„Ù…Ø§Ø¯Ø©','subject'])),
    deg:  String(findAlias(['Ø§Ù„Ù…Ø±ØªØ¨Ø©','Ø§Ù„Ù…Ø¤Ù‡Ù„','Ø§Ù„ÙˆØ¸ÙŠÙØ©','degree','Ù…Ø¤Ù‡Ù„'])),
    phone:String(findAlias(['Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„','Ø§Ù„Ø¬ÙˆØ§Ù„','Ø§Ù„Ù‡Ø§ØªÙ','mobile','phone','Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ'])),
    email:String(findAlias(['Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„','Ø§Ù„Ø¨Ø±ÙŠØ¯','email','Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ','Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ']))
  };

  fillSelectWithColumns($('#mapName'), wiz.headers);  $('#mapName').value=wiz.map.name;
  fillSelectWithColumns($('#mapId'), wiz.headers);    $('#mapId').value=wiz.map.id;
  fillSelectWithColumns($('#mapSpec'), wiz.headers);  $('#mapSpec').value=wiz.map.spec;
  fillSelectWithColumns($('#mapDeg'), wiz.headers);   $('#mapDeg').value=wiz.map.deg;
  fillSelectWithColumns($('#mapPhone'), wiz.headers); $('#mapPhone').value=wiz.map.phone;
  fillSelectWithColumns($('#mapEmail'), wiz.headers); $('#mapEmail').value=wiz.map.email;

  $('#mapName').onchange=e=>wiz.map.name=e.target.value;
  $('#mapId').onchange=e=>wiz.map.id=e.target.value;
  $('#mapSpec').onchange=e=>wiz.map.spec=e.target.value;
  $('#mapDeg').onchange=e=>wiz.map.deg=e.target.value;
  $('#mapPhone').onchange=e=>wiz.map.phone=e.target.value;
  $('#mapEmail').onchange=e=>wiz.map.email=e.target.value;

  renderWizardTable();
  $('#wizHint').textContent='Ø§Ø®ØªØ± ØµÙ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø«Ù… Ø¹ÙŠÙ‘Ù† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©. ÙŠÙƒÙÙŠ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡ÙˆÙŠØ©ØŒ ÙˆÙŠÙØ¶Ù‘Ù„ Ø§Ù„Ù‡ÙˆÙŠØ© Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„ØªÙƒØ±Ø§Ø±.';
  $('#importWizard').style.display='flex';
}
$('#wizClose').onclick=()=>$('#importWizard').style.display='none';
$('#wizCancel').onclick=()=>$('#importWizard').style.display='none';

$('#wizApply').onclick=async ()=>{
  const ci = {
    name:  $('#mapName').value===''? -1 : Number($('#mapName').value),
    id:    $('#mapId').value===''? -1 : Number($('#mapId').value),
    spec:  $('#mapSpec').value===''? -1 : Number($('#mapSpec').value),
    deg:   $('#mapDeg').value===''? -1 : Number($('#mapDeg').value),
    phone: $('#mapPhone').value===''? -1 : Number($('#mapPhone').value),
    email: $('#mapEmail').value===''? -1 : Number($('#mapEmail').value)
  };
  const dataRows = wiz.rows.slice(wiz.headerRow+1);
  let imported=0, skipped=0;

  for(const r of dataRows){
    if(!r || r.every(c=>String(c||'').trim()==='')){ skipped++; continue; }
    const name  = ci.name>-1 ? String(r[ci.name]||'').trim() : '';
    const natId = ci.id>-1 ? likelyId(r[ci.id]) : '';
    const spec  = ci.spec>-1 ? String(r[ci.spec]||'').trim() : '';
    const degree= ci.deg>-1 ? String(r[ci.deg]||'').trim() : '';
    let phone   = ci.phone>-1 ? String(r[ci.phone]||'').trim() : '';
    phone = digitsOnly(phone);
    const email = ci.email>-1 ? String(r[ci.email]||'').trim() : '';

    const anyVal=[name,natId,spec,degree,phone,email].some(v=>v && String(v).trim()!=='');
    if(!anyVal){ skipped++; continue; }
    if(!name && !natId){ skipped++; continue; }

    const rec = {
      teacherId: natId || ('name:'+arNorm(name)),
      name: name || 'â€”',
      nationalId: natId,
      spec, degree, phone, email,
      class:'', lesson:'',
      visits:{1:{finalized:false,draft:zeroSupport()},2:{finalized:false,draft:zeroSupport()},3:{finalized:false,draft:zeroSupport()}}
    };
    const old = await dbGet(rec.teacherId);
    await dbPut({...old,...rec, teacherId:(old?.teacherId||rec.teacherId)});
    imported++;
  }

  $('#importWizard').style.display='none';
  if(imported===0){
    snack('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙÙˆÙ ØµØ§Ù„Ø­Ø© Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙŠØ¯ÙˆÙŠ.',false);
  }else{
    snack(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${imported} Ø³Ø¬Ù„${imported>1?'Ø§Øª':''}. ${skipped?('ØªØ¬Ø§ÙˆØ²: '+skipped+' ØµÙ.'):''}`, true);
    await refreshLens();
  }
};
</script>
<!-- ============ PART 18 / 20 ============ -->
<script>
/* Ø¹Ø¯Ø³Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ + Ø§Ø³ØªÙŠØ±Ø§Ø¯ + Ù‚Ø§Ù„Ø¨ */
const lensBtn=$('#btnLens'), lensMenu=$('#lensMenu'), lensSelect=$('#lensSelect'), lensSearch=$('#lensSearch');

lensBtn.onclick=()=>{
  lensMenu.style.display=lensMenu.style.display==='block'?'none':'block';
  refreshLens();
};
document.addEventListener('click',e=>{
  if(!lensMenu.contains(e.target) && !lensBtn.contains(e.target)) lensMenu.style.display='none';
});

async function refreshLens(){
  const q=(lensSearch.value||'').trim();
  const list=(await dbAll())||[];
  list.sort((a,b)=>{
    const af=(+!!(a.visits?.[1]?.finalized)+ +!!(a.visits?.[2]?.finalized)+ +!!(a.visits?.[3]?.finalized));
    const bf=(+!!(b.visits?.[1]?.finalized)+ +!!(b.visits?.[2]?.finalized)+ +!!(b.visits?.[3]?.finalized));
    if(af!==bf) return bf-af;
    return (a.name||'').localeCompare(b.name||'','ar');
  });
  const filtered=q? list.filter(t=> (t.name||'').includes(q) || (t.nationalId||'').includes(q) ):list;

  lensSelect.innerHTML='<option value="">â€” Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù…Ø§Ù‹ â€”</option>'+filtered.map(t=>{
    const v1=!!(t.visits?.[1]?.finalized), v2=!!(t.visits?.[2]?.finalized), v3=!!(t.visits?.[3]?.finalized);
    const count=(v1?1:0)+(v2?1:0)+(v3?1:0);
    const dot=count===0?'ğŸŸ¥':(count===1?'ğŸŸ¨':'ğŸŸ©');
    const tail=t.nationalId?` (${t.nationalId})`:'';
    return `<option value="${t.teacherId}">${dot} ${t.name||'â€”'}${tail}</option>`;
  }).join('');
}
lensSearch.addEventListener('input',dfn(refreshLens,200));

lensSelect.addEventListener('change',async e=>{
  const key=e.target.value; if(!key) return;
  const rec=await dbGet(key); if(!rec) return;
  $('#tName').value=rec.name||'';
  $('#tId').value=rec.nationalId||'';
  $('#tSpec').value=rec.spec||'';
  $('#degree').value=rec.degree||'';
  $('#class').value=rec.class||'';
  $('#lesson').value=rec.lesson||'';
  $('#mailTo').value=rec.email||($('#mailTo').value||'');
  $('#waPhone').value=rec.phone||($('#waPhone').value||'');
  fixedKey=rec.teacherId; loadedRecord=rec;
  await renderFromRecord();
  lensMenu.style.display='none';
});

$('#lensImport').onclick=()=>$('#excelInput').click();

$('#excelInput').addEventListener('change',async e=>{
  const f=e.target.files[0]; e.target.value='';
  if(!f) return;
  try{
    const rows=await fileToRows(f);
    if(!rows || !rows.length){ snack('Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù‚Ø±Ø§Ø¡Ø©.',false); return; }
    openWizard(rows);
  }catch(err){
    console.error(err);
    snack('ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯. Ø¥Ù† ÙƒØ§Ù† PDF Ù…ØµÙˆÙ‘Ø±Ù‹Ø§ØŒ Ø­ÙˆÙ‘Ù„Ù‡ Ø¥Ù„Ù‰ PDF Ù†ØµÙ‘ÙŠ/Excel.',false);
  }
});

/* Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ù„Ø¨ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ */
$('#lensTemplate').onclick=()=>{
  const choice = prompt('Ø§Ø®ØªØ± Ø§Ù„ØµÙŠØºØ©: Ø§ÙƒØªØ¨ XLSX Ø£Ùˆ CSV','XLSX');
  const headers = ['Ø§Ù„Ø§Ø³Ù…','Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©','Ø§Ù„ØªØ®ØµØµ','Ø§Ù„Ù…Ø±ØªØ¨Ø©','Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„','Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ'];
  if(!choice) return;
  const fmt=choice.trim().toUpperCase();

  if(fmt==='CSV'){
    const csv = '\ufeff' + headers.join(',') + '\n';
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'Ù‚Ø§Ù„Ø¨_Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†.csv';
    a.click();
    URL.revokeObjectURL(a.href);
    snack('ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ù‚Ø§Ù„Ø¨ CSV.');
  }else{
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([headers, ['','','','','','']]);
    XLSX.utils.book_append_sheet(wb, ws, 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†');
    XLSX.writeFile(wb, 'Ù‚Ø§Ù„Ø¨_Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†.xlsx');
    snack('ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ù‚Ø§Ù„Ø¨ XLSX.');
  }
};

/* ÙˆØ¸Ø§Ø¦Ù Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ø§Ø²Ù…Ø© Ù„Ù„ØªØ´ØºÙŠÙ„ */
function syncSignNames(){
  const nm=($('#tName').value||'').trim()||'â€”';
  ['sn1','sn2','sn3'].forEach(id=>$('#'+id).textContent=nm);
}
function calcAll(){
  setDonut(1,visitScore(1));
  setDonut(2,visitScore(2));
  setDonut(3,visitScore(3));
  setVisitMeter();
  setGlobalMeter();
  updateToolsSummary();
}

/* Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙ‘Ø± Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */
['tName','tId','tSpec','degree','class','lesson'].forEach(id=>{
  const el=$('#'+id);
  if(!el) return;
  el.addEventListener('input',dfn(async ()=>{
    syncSignNames();
    saveLastContext();
    await saveDraft();
    calcAll();
  },220));
});

/* ØªØ¹ÙŠÙŠÙ† ØªØ§Ø±ÙŠØ® Ø§ÙØªØ±Ø§Ø¶ÙŠ */
(function initDefaultDates(){
  const d=hijriNow();
  const hidden=$('#visitDateInline');
  if(hidden && !hidden.value) hidden.value=d;
  if($('#v'+activeVisit+'h').textContent==='â€”') $('#v'+activeVisit+'h').textContent=d;
  $('#sh'+activeVisit).textContent = $('#v'+activeVisit+'h').textContent || d;
})();

/* Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„Ø£Ø®ÙŠØ± */
(async function restoreLast(){
  fitHeaderToImage();
  buildLearning();
  buildTools();
  syncSignNames();
  calcAll();

  const ctx=loadLastContext();
  if(ctx && ctx.key){
    const rec=await dbGet(ctx.key);
    if(rec){
      $('#tName').value=rec.name||'';
      $('#tId').value=rec.nationalId||'';
      $('#tSpec').value=rec.spec||'';
      $('#degree').value=rec.degree||'';
      $('#class').value=rec.class||'';
      $('#lesson').value=rec.lesson||'';
      $('#mailTo').value=rec.email||($('#mailTo').value||'');
      $('#waPhone').value=rec.phone||($('#waPhone').value||'');
      fixedKey=rec.teacherId; loadedRecord=rec;
      activeVisit = ctx.activeVisit || 1;
      await renderFromRecord();
      calcAll();
    }
  }
})();

/* Ø­Ù…Ø§ÙŠØ© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù‡ÙˆÙŠØ© (10 Ø£Ø±Ù‚Ø§Ù…) */
$('#tId').addEventListener('input',()=>{
  const el=$('#tId');
  const v=digitsOnly(el.value).slice(0,10);
  el.value=v;
});

/* Ø­ÙØ¸ Ø§Ù„Ø¯Ø¹Ù… Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ */
$('#supportArea').addEventListener('input',dfn(()=>{ saveDraft(); },240));
</script>
<!-- ============ PART 19 / 20 (FULL FIX â€” Algorithmic Binding) ============ -->
<script>
(function(){
  "use strict";

  /* =========
     Ø£Ø¯ÙˆØ§Øª Ø¢Ù…Ù†Ø© (Ø¨Ø¯ÙˆÙ† ØªØ¹Ø§Ø±Ø¶)
     ========= */
  const el = (id)=>document.getElementById(id);
  const esc = (s)=>String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  const toast = (msg, ok=true)=>{ try{ if(typeof window.snack==="function"){ window.snack(msg, ok); return; } }catch{} if(!ok) alert(msg); else console.log(msg); };
  const debounce = (fn, ms=180)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };

  async function copyText(txt){
    try{ await navigator.clipboard.writeText(txt); }
    catch{
      const ta=document.createElement('textarea');
      ta.value=txt; ta.style.position='fixed'; ta.style.left='-9999px';
      document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
    }
  }

  function getHijri(){
    return (el('visitDateInline')?.value || el('todayHijri')?.textContent || (typeof window.hijriNow==="function"?window.hijriNow():"â€”") || "â€”").trim();
  }
  function getEdu(){ return (el('h-dir')?.value || 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ©').trim(); }
  function getSchool(){ return (el('h-school')?.value || 'Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ Ø¨Ø§Ù„Ø®Ø¨Ø±').trim(); }
  function getPrincipal(){
    try{ return (localStorage.getItem('yaqfb_principal') || el('pr1Name')?.textContent || 'ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ').trim(); }
    catch{ return (el('pr1Name')?.textContent || 'ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ').trim(); }
  }

  function getTeacherFromUI(){
    const name=(el('tName')?.value||'').trim();
    const nid =(el('tId')?.value||'').trim();
    if(!name && !nid) return null;
    return {
      name: name||'â€”',
      nid:  nid||'â€”',
      spec:(el('tSpec')?.value||'â€”').trim(),
      degree:(el('degree')?.value||'â€”').trim(),
      klass:(el('class')?.value||'â€”').trim(),
      lesson:(el('lesson')?.value||'â€”').trim()
    };
  }

  const visitLabel = (v)=> v===1?'Ø§Ù„Ø£ÙˆÙ„Ù‰':(v===2?'Ø§Ù„Ø«Ø§Ù†ÙŠØ©':'Ø§Ù„Ø«Ø§Ù„Ø«Ø© (Ø¯Ø¹Ù…)');

  /* =========
     Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø®ÙˆØ§Ø±Ø²Ù…ÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„
     - ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ loadedRecord + visits[v].draft
     - fallback: Ù…Ù† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù† Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„
     ========= */
  function safeClone(o){ try{return JSON.parse(JSON.stringify(o));}catch{return o;} }

  function getDraftForVisit(v){
    // 1) Ù…Ù† Ø§Ù„Ø³Ø¬Ù„ Ø¥Ù† ÙˆØ¬Ø¯
    try{
      if(window.loadedRecord && window.loadedRecord.visits && window.loadedRecord.visits[v] && window.loadedRecord.visits[v].draft){
        return window.loadedRecord.visits[v].draft;
      }
    }catch{}
    // 2) fallback: Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© (Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙ‚Ø·)
    const fallback = {
      ratings: null,
      tools: null,
      reasons: null,
      supportDetailed: null,
      support: null,
      date: (el('v'+v+'h')?.textContent || getHijri()).trim()
    };
    try{
      if(typeof window.clone==="function" && window.store){
        fallback.ratings = window.clone(window.store[v] || window.store[window.activeVisit] || []);
      }
    }catch{}
    try{ if(typeof window.getToolsStateFromUI==="function") fallback.tools = window.getToolsStateFromUI(); }catch{}
    try{ if(typeof window.getToolReasonsFromUI==="function") fallback.reasons = window.getToolReasonsFromUI(); }catch{}
    try{
      if(typeof window.ensureSupport==="function"){
        const det = window.ensureSupport() || [];
        fallback.supportDetailed = det;
        fallback.support = det.map(x=>x.text);
      }
    }catch{}
    return fallback;
  }

  function scoreForVisit(v){
    try{ if(typeof window.visitScore==="function") return Number(window.visitScore(v)||0); }catch{}
    return 0;
  }
  function levelText(p){
    if(p>=80) return 'Ù…ØªÙ…ÙŠØ²';
    if(p>=50) return 'Ù…ØªÙˆØ³Ø·';
    return 'Ø¶Ø¹ÙŠÙ';
  }

  /* =========
     ØªÙˆÙ„ÙŠØ¯ â€œØªØ­Ù„ÙŠÙ„ ÙØ¬ÙˆØ§Øªâ€ Ù…Ù† ratings (Ø£Ø¶Ø¹Ù Ù…Ø¬Ø§Ù„ÙŠÙ†)
     ========= */
  function analyzeWeakDomains(ratingsMatrix){
    try{
      if(!ratingsMatrix || !Array.isArray(ratingsMatrix) || !window.fields) return [];
      const arr = window.fields.map((f,fi)=>{
        const row = (ratingsMatrix[fi]||[]).filter(x=>x>0);
        const avg = row.length ? (row.reduce((a,b)=>a+b,0)/row.length) : 0;
        return { dom:f.name, fi, avg };
      });
      arr.sort((a,b)=>a.avg-b.avg);
      return arr.slice(0,2).filter(x=>x.avg>0 || true);
    }catch{ return []; }
  }

  /* =========
     HTML Styles Ù„Ù„ØªÙ‚Ø±ÙŠØ±/Ø§Ù„Ù€PDF (Ø­Ù„ Ø§Ù„Ø¨Ù†Ø± ÙÙ‚Ø· + ÙˆØ¶ÙˆØ­ + ØªØ±ÙˆÙŠØ³Ø©)
     ========= */
  function reportStyles(){
    return `
<style>
@page{size:A4;margin:10mm;}
*{box-sizing:border-box}
body{margin:0;background:#fff;color:#123b37;font-family:"Tajawal",system-ui}
.toolbar{position:sticky;top:0;z-index:50;display:flex;gap:8px;justify-content:flex-end;align-items:center;padding:10px 12px;background:#fff;border-bottom:1px solid #e6efec}
.btn{border:1px solid #cfe1dd;background:#e8f4f1;color:#0c594e;border-radius:10px;padding:8px 12px;font-weight:900;cursor:pointer}
.sheet{max-width:190mm;margin:0 auto;padding:0 0 12px}
.hdrImg{width:100%;border-radius:18px;overflow:hidden;margin:10px 0;border:1px solid #e6efec}
.hdrImg img{width:100%;height:auto;display:block}
.headBox{border:1px solid #e6efec;border-radius:16px;background:#fbfdfc;padding:10px 12px;margin:0 0 10px}
.row{display:flex;gap:10px;justify-content:space-between;flex-wrap:wrap}
.cell{flex:1;min-width:240px;border:1px solid #cfe1dd;background:#e8f4f1;border-radius:12px;padding:8px 10px;font-weight:900}
.cell b{font-weight:900}
h1,h2{margin:6px 0 10px;color:#0f7a66;font-family:"Cairo";text-align:center}
.badges{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin:6px 0 10px}
.badge{border:1px solid #e6efec;background:#e8f4f1;color:#0c594e;border-radius:10px;padding:4px 8px;font-weight:900;font-size:11px}
.block{border:1px solid #e6efec;border-radius:14px;padding:10px;margin:10px 0;break-inside:auto;page-break-inside:auto}
.blockHead{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;font-weight:900;color:#0c594e;border-bottom:1px dashed #cfe1dd;padding-bottom:6px;margin-bottom:8px}
.small{font-size:11px;color:#0c594e;font-weight:900}
.tbl{width:100%;border-collapse:collapse;table-layout:fixed}
.tbl th,.tbl td{border:1px solid #cfe1dd;padding:6px;font-size:11px;text-align:center;vertical-align:top;word-wrap:break-word}
.tbl th{background:#0c594e;color:#fff}
.tag{display:inline-block;padding:.1rem .45rem;border-radius:8px;border:1px solid #0f7a66;color:#0f7a66;background:#f5fffb;font-size:10px;font-weight:900;margin-inline-start:6px}
ul{margin:6px 0 0 0;padding:0 18px}
li{margin:4px 0;text-align:right}
.foot{margin:10px 0 0;text-align:center;font-size:11px;color:#0c594e;font-weight:900}
@media print{ .toolbar{display:none!important} .sheet{max-width:unset;margin:0} }
</style>`;
  }

  function headerHTML(teacher){
    const edu = esc(getEdu());
    const sch = esc(getSchool());
    const pr  = esc(getPrincipal());
    const dt  = esc(getHijri());
    const hdrSrc = el('hdrImg')?.getAttribute('src') || '';
    const hdrImg = hdrSrc ? `<div class="hdrImg"><img src="${esc(hdrSrc)}" alt=""></div>` : '';
    return `
      ${hdrImg}
      <div class="headBox">
        <div class="row">
          <div class="cell">
            <b>${edu}</b> â€” <b>${sch}</b><br>
            Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…: <b>${esc(teacher.name)}</b>
          </div>
          <div class="cell" style="text-align:left">
            Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: <b>${pr}</b><br>
            Ø§Ù„ØªØ§Ø±ÙŠØ®: <b>${dt}</b>
          </div>
        </div>
      </div>`;
  }

  function teacherBadges(teacher, p, lvl){
    return `
      <div class="badges">
        <span class="badge">Ø§Ù„Ù‡ÙˆÙŠØ©: ${esc(teacher.nid)}</span>
        <span class="badge">Ø§Ù„ØªØ®ØµØµ: ${esc(teacher.spec)}</span>
        <span class="badge">Ø§Ù„Ù…Ø±ØªØ¨Ø©: ${esc(teacher.degree)}</span>
        <span class="badge">Ø§Ù„ÙØµÙ„: ${esc(teacher.klass)}</span>
        <span class="badge">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³: ${esc(teacher.lesson)}</span>
        <span class="badge">Ø§Ù„Ù†ØªÙŠØ¬Ø©: <b>${esc(lvl)}</b> (${Number(p)||0}%)</span>
      </div>`;
  }

  function ratingsTableHTML(draft){
    try{
      if(!draft?.ratings || !window.fields) return `<div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ‚ÙŠÙŠÙ… Ù…ÙØµÙ„Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø²ÙŠØ§Ø±Ø©.</div>`;
      const m = draft.ratings;
      let rows = '';
      window.fields.forEach((f,fi)=>{
        (f.items||[]).forEach((pair,ii)=>{
          const item = pair[0];
          const v = (m[fi] && typeof m[fi][ii]!=='undefined') ? Number(m[fi][ii]) : 0;
          if(!v) return;
          const bank = (window.learnBank && window.learnBank[f.name] && window.learnBank[f.name][item]) ? window.learnBank[f.name][item] : null;
          const ok = (v===3 && bank)? bank.ok : (v===2 ? 'ØªÙ‚Ø¯Ù‘Ù… Ù…Ù„Ø­ÙˆØ¸ ÙŠØ­ØªØ§Ø¬ ØªØ«Ø¨ÙŠØªÙ‹Ø§.' : 'â€”');
          const need = (v<=2 && bank)? bank.need : 'â€”';
          rows += `<tr>
            <td>${esc(f.name)}</td>
            <td>${esc(item)}</td>
            <td>${v===3?'Ù…ØªÙ…ÙŠØ²':(v===2?'Ù…ØªÙˆØ³Ø·':'Ø¶Ø¹ÙŠÙ')}</td>
            <td>${esc(ok)}</td>
            <td>${esc(need)}</td>
          </tr>`;
        });
      });
      if(!rows) return `<div class="small">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªÙˆÙŠØ§Øª Ø£Ø¯Ø§Ø¡ Ø¯Ø§Ø®Ù„ Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„ØªØ¹Ù„Ù….</div>`;
      return `
        <table class="tbl">
          <thead>
            <tr>
              <th>Ø§Ù„Ù…Ø¬Ø§Ù„</th>
              <th>Ø§Ù„Ø¹Ù†ØµØ±</th>
              <th>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</th>
              <th>Ø¬ÙˆØ§Ù†Ø¨ Ø§Ù„ØªÙ…ÙŠÙ‘Ø²</th>
              <th>Ø§Ø­ØªÙŠØ§Ø¬Ø§Øª Ø§Ù„ØªÙ†Ù…ÙŠØ© Ø§Ù„Ù…Ù‡Ù†ÙŠØ©</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>`;
    }catch{
      return `<div class="small">ØªØ¹Ø°Ø± Ø¨Ù†Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ….</div>`;
    }
  }

  function toolsTableHTML(draft){
    try{
      const states = Array.isArray(draft?.tools) ? draft.tools : [];
      const reasons = Array.isArray(draft?.reasons) ? draft.reasons : [];
      if(!window.toolsData || !window.toolsData.length) return `<div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ù†Ø¯Ø© Ù…Ø¹Ø±ÙØ©.</div>`;

      let rows='';
      window.toolsData.forEach((t,i)=>{
        const s = (typeof states[i]!=='undefined' && states[i]!=null) ? Number(states[i]) : null; // 0/1/2
        const label = (s===2?'Ù…ÙÙØ¹Ù„':(s===1?'Ø¥Ù„Ù‰ Ø­Ø¯ Ù…Ø§':(s===0?'ØºÙŠØ± Ù…ÙÙØ¹Ù„':'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')));
        const why = (reasons[i]||'').trim();
        rows += `<tr>
          <td>${i+1}</td>
          <td>${esc(t.title||'â€”')}</td>
          <td>${esc(label)}</td>
          <td>${esc(why || (s===2?'â€”':''))}</td>
        </tr>`;
      });

      return `
        <table class="tbl">
          <thead><tr><th>Ù…</th><th>Ø§Ù„Ø£Ø¯Ø§Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø£Ø³Ø¨Ø§Ø¨ Ø¹Ø¯Ù… Ø§Ù„ØªÙØ¹ÙŠÙ„/Ø§Ù„Ø¬Ø²Ø¦ÙŠ</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>`;
    }catch{
      return `<div class="small">ØªØ¹Ø°Ø± Ø¨Ù†Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø¯ÙˆØ§Øª.</div>`;
    }
  }

  function supportHTML(draft){
    try{
      const det = Array.isArray(draft?.supportDetailed) ? draft.supportDetailed : [];
      const lines = det.length ? det.map(x=>`<li>â–¡ ${esc(x.text)} ${x.src?`<span class="tag">${esc(x.src)}</span>`:''}</li>`).join('')
                              : (Array.isArray(draft?.support) ? draft.support : []).map(t=>`<li>â–¡ ${esc(t)}</li>`).join('');
      return `<ul>${lines || '<li>â€”</li>'}</ul>`;
    }catch{
      return `<ul><li>â€”</li></ul>`;
    }
  }

  function weakSummaryHTML(draft){
    const weak = analyzeWeakDomains(draft?.ratings);
    if(!weak.length) return '';
    const a = weak.map(w=>`<span class="badge">Ø£ÙˆÙ„ÙˆÙŠØ© Ø¯Ø¹Ù…: ${esc(w.dom)}</span>`).join('');
    return `<div class="badges">${a}</div>`;
  }

  function buildVisitBlock(v, teacher, draft){
    const p = scoreForVisit(v);
    const lvl = levelText(p);
    const dt = (draft?.date || el('v'+v+'h')?.textContent || getHijri()).trim() || 'â€”';

    return `
      <div class="block">
        <div class="blockHead">
          <div>Ø§Ù„Ø²ÙŠØ§Ø±Ø© ${esc(visitLabel(v))}</div>
          <div class="small">Ø§Ù„ØªØ§Ø±ÙŠØ®: ${esc(dt)} â€” Ø§Ù„Ù†ØªÙŠØ¬Ø©: <b>${esc(lvl)}</b> (${Number(p)||0}%)</div>
        </div>

        ${teacherBadges(teacher, p, lvl)}
        ${weakSummaryHTML(draft)}

        <div style="margin-top:8px;font-weight:900;color:#0c594e;text-align:center">Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„ØªØ¹Ù„Ù‘Ù…</div>
        ${ratingsTableHTML(draft)}

        <div style="margin-top:10px;font-weight:900;color:#0c594e;text-align:center">Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø§Ù†Ø¯Ø©</div>
        ${toolsTableHTML(draft)}

        <div style="margin-top:10px;font-weight:900;color:#0c594e;text-align:center">Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„Ù…Ù‚Ø¯Ù‘Ù… Ù„Ù„Ù…Ø¹Ù„Ù…</div>
        ${supportHTML(draft)}
      </div>`;
  }

  function openPopup(html, title){
    const w = window.open('about:blank','_blank');
    if(!w){ toast('Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù†Ø¹ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©. Ø§Ø³Ù…Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©.', false); return; }
    w.document.open();
    w.document.write(html);
    w.document.close();
    try{ w.document.title = title||w.document.title; }catch{}
  }

  async function openReportSingle(){
    // Ø§Ø­ÙØ¸ Ø¢Ø®Ø± ØªØºÙŠÙŠØ±Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
    try{ if(typeof window.saveDraft==="function") await window.saveDraft(); }catch{}

    const teacher = getTeacherFromUI();
    if(!teacher){ toast('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø£ÙˆÙ„Ø§Ù‹.', false); return; }

    const v = Number(window.activeVisit||1);
    const draft = getDraftForVisit(v);

    const html = `<!doctype html><html lang="ar" dir="rtl"><head><meta charset="utf-8">
      <title>ØªÙ‚Ø±ÙŠØ± Ø²ÙŠØ§Ø±Ø© â€” ${esc(teacher.name)}</title>
      ${reportStyles()}
    </head><body>
      <div class="toolbar">
        <button class="btn" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø©</button>
        <button class="btn" onclick="window.close()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="sheet">
        ${headerHTML(teacher)}
        <h2>ØªÙ‚Ø±ÙŠØ± Ø²ÙŠØ§Ø±Ø© ØµÙÙŠØ© â€” Ø§Ù„Ø²ÙŠØ§Ø±Ø© ${esc(visitLabel(v))}</h2>
        ${buildVisitBlock(v, teacher, draft)}
        <div class="foot">ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø© (Ø®ÙˆØ§Ø±Ø²Ù…ÙŠÙ‹Ø§).</div>
      </div>
    </body></html>`;
    openPopup(html, `ØªÙ‚Ø±ÙŠØ± Ø²ÙŠØ§Ø±Ø© â€” ${teacher.name}`);
  }

  async function openReportAll(){
    // Ø§Ø­ÙØ¸ Ø¢Ø®Ø± ØªØºÙŠÙŠØ±Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„
    try{ if(typeof window.saveDraft==="function") await window.saveDraft(); }catch{}

    const teacher = getTeacherFromUI();
    if(!teacher){ toast('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø£ÙˆÙ„Ø§Ù‹.', false); return; }

    const d1=getDraftForVisit(1), d2=getDraftForVisit(2), d3=getDraftForVisit(3);

    const html = `<!doctype html><html lang="ar" dir="rtl"><head><meta charset="utf-8">
      <title>ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ â€” ${esc(teacher.name)}</title>
      ${reportStyles()}
    </head><body>
      <div class="toolbar">
        <button class="btn" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø©</button>
        <button class="btn" onclick="window.close()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="sheet">
        ${headerHTML(teacher)}
        <h1>ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…</h1>
        ${buildVisitBlock(1, teacher, d1)}
        ${buildVisitBlock(2, teacher, d2)}
        ${buildVisitBlock(3, teacher, d3)}
        <div class="foot">Ø­Ø±Ø± ÙÙŠ: ${esc(getHijri())} â€” Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: ${esc(getPrincipal())}</div>
      </div>
    </body></html>`;
    openPopup(html, `ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ â€” ${teacher.name}`);
  }

  /* =========
     Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª (Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ§Ù‹)
     ========= */
  function buildCommsMessage(){
    const teacher = getTeacherFromUI();
    if(!teacher) return '';

    const v = Number(window.activeVisit||1);
    const draft = getDraftForVisit(v);
    const p = scoreForVisit(v);
    const lvl = levelText(p);
    const dt = (draft?.date || el('v'+v+'h')?.textContent || getHijri()).trim();

    const weak = analyzeWeakDomains(draft?.ratings).map(x=>`- ${x.dom}`).join('\n') || '- â€”';

    const tools = (function(){
      try{
        const states = Array.isArray(draft?.tools)?draft.tools:[];
        const reasons= Array.isArray(draft?.reasons)?draft.reasons:[];
        if(!window.toolsData) return 'â€”';
        const bad=[];
        window.toolsData.forEach((t,i)=>{
          const s = (typeof states[i]!=='undefined' && states[i]!=null) ? Number(states[i]) : null;
          if(s===0 || s===1){
            const st = (s===0?'ØºÙŠØ± Ù…ÙÙØ¹Ù„':'Ø¥Ù„Ù‰ Ø­Ø¯ Ù…Ø§');
            const rs = (reasons[i]||'').trim();
            bad.push(`- ${t.title} (${st})${rs?` â€” Ø§Ù„Ø³Ø¨Ø¨: ${rs}`:''}`);
          }
        });
        return bad.length?bad.join('\n'):'â€”';
      }catch{ return 'â€”'; }
    })();

    const support = (function(){
      const det = Array.isArray(draft?.supportDetailed)?draft.supportDetailed:[];
      const lines = det.length? det.map(x=>`- ${x.text}`).join('\n')
                              : (Array.isArray(draft?.support)?draft.support:[]).map(x=>`- ${x}`).join('\n');
      return lines || '- â€”';
    })();

    return [
      getEdu(),
      getSchool(),
      `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dt || getHijri()}`,
      `Ø§Ù„Ù…Ø¹Ù„Ù…: ${teacher.name} â€” Ø§Ù„Ù‡ÙˆÙŠØ©: ${teacher.nid}`,
      `Ø§Ù„ØªØ®ØµØµ: ${teacher.spec} â€” Ø§Ù„Ù…Ø±ØªØ¨Ø©: ${teacher.degree}`,
      `Ø§Ù„ÙØµÙ„: ${teacher.klass} â€” Ø§Ù„Ø¯Ø±Ø³: ${teacher.lesson}`,
      `Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø²ÙŠØ§Ø±Ø© (${visitLabel(v)}): ${lvl} (${Number(p)||0}%)`,
      ``,
      `Ø£ÙˆÙ„ÙˆÙŠØ§Øª Ø§Ù„ØªØ·ÙˆÙŠØ± (ÙˆÙÙ‚ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…):`,
      `${weak}`,
      ``,
      `Ø£Ø¯ÙˆØ§Øª ØªØ­ØªØ§Ø¬ ØªÙØ¹ÙŠÙ„/ØªØ­Ø³ÙŠÙ†:`,
      `${tools}`,
      ``,
      `Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„Ù…Ù‚ØªØ±Ø­ Ù„Ù„Ù…Ø¹Ù„Ù…:`,
      `${support}`,
      ``,
      `Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: ${getPrincipal()}`
    ].join('\n');
  }

  function openCommsPanel(){
    const panel = el('commsPanel');
    if(!panel){ toast('Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.', false); return; }
    panel.style.display='block';
    makeComms();
  }
  function closeCommsPanel(){ const panel=el('commsPanel'); if(panel) panel.style.display='none'; }

  function makeComms(){
    const txt = buildCommsMessage();
    if(!txt){ toast('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø£ÙˆÙ„Ø§Ù‹.', false); return; }
    const box = el('commsTxt');
    if(box) box.value = txt;
    toast('ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.');
  }
  async function copyComms(){
    const box=el('commsTxt');
    const txt=(box?.value||'').trim();
    if(!txt){ toast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù†Ø³Ø®.', false); return; }
    await copyText(txt);
    toast('ØªÙ… Ø§Ù„Ù†Ø³Ø®.');
  }
  function openWA(){
    const box=el('commsTxt');
    const txt=(box?.value||buildCommsMessage()||'').trim();
    if(!txt){ toast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ù„Ø©.', false); return; }
    const phone=(el('waPhone')?.value||'').trim();
    const url = phone ? `https://wa.me/${encodeURIComponent(phone)}?text=${encodeURIComponent(txt)}`
                      : `https://wa.me/?text=${encodeURIComponent(txt)}`;
    window.open(url,'_blank','noopener');
  }
  function openMail(){
    const box=el('commsTxt');
    const txt=(box?.value||buildCommsMessage()||'').trim();
    if(!txt){ toast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ù„Ø©.', false); return; }
    const mail=(el('mailTo')?.value||'').trim();
    const t = getTeacherFromUI() || {name:'â€”'};
    const subject = `ØªÙ‚Ø±ÙŠØ± Ø²ÙŠØ§Ø±Ø© â€” ${t.name}`;
    window.location.href = `mailto:${encodeURIComponent(mail)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(txt)}`;
  }

  // Ø­ÙØ¸ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Øª (Ø¨Ø±ÙŠØ¯/ÙˆØ§ØªØ³Ø§Ø¨) + ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ù† ÙˆØ¬Ø¯
  function saveCommsDefaults(){
    const mail=(el('mailTo')?.value||'').trim();
    const wa=(el('waPhone')?.value||'').trim();
    try{
      localStorage.setItem('yaqfb_mailTo', mail);
      localStorage.setItem('yaqfb_waPhone', wa);
    }catch{}
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ù† ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    (async()=>{
      try{
        if(typeof window.ensureRecord==="function"){
          const rec=await window.ensureRecord();
          if(rec){
            rec.email = mail || rec.email;
            rec.phone = wa || rec.phone;
            if(typeof window.dbPut==="function") await window.dbPut(rec);
            window.loadedRecord = rec;
          }
        }
      }catch{}
    })();
    toast('ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ.');
  }

  // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¥Ù† ÙˆÙØ¬Ø¯)
  async function fetchCommsFromDB(){
    try{
      if(typeof window.ensureRecord!=="function"){ toast('ØªØ¹Ø°Ø± Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø³Ø¬Ù„.', false); return; }
      const rec=await window.ensureRecord();
      if(!rec){ toast('Ø£Ø¯Ø®Ù„ Ù‡ÙˆÙŠØ©/Ø§Ø³Ù… Ø«Ù… Ø§Ø­ÙØ¸ Ù…Ø³ÙˆØ¯Ø©.', false); return; }
      if(rec.email) el('mailTo').value = rec.email;
      if(rec.phone) el('waPhone').value = rec.phone;
      toast('ØªÙ… Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„.');
    }catch{
      toast('ØªØ¹Ø°Ø± Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„.', false);
    }
  }

  /* =========
     Ø§Ù„Ø­Ø§ÙØ¸Ø© + Ø§Ø¹ØªÙ…Ø§Ø¯/Ù…Ø³Ø­
     ========= */
  function openVault(){
    const p = el('approvedPanel');
    if(!p) return;
    p.style.display = (p.style.display==='block') ? 'none' : 'block';
    refreshVault();
  }
  function closeVault(){
    const p = el('approvedPanel');
    if(p) p.style.display='none';
  }

  async function refreshVault(){
    const listEl = el('approvedList');
    if(!listEl) return;
    listEl.innerHTML = '...';

    try{
      if(typeof window.dbAll!=="function"){ listEl.innerHTML='ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª.'; return; }
      const all = await window.dbAll();
      if(!all || !all.length){ listEl.innerHTML='Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯.'; return; }

      // Ø§Ø¹Ø±Ø¶ Ù…Ù† Ù„Ø¯ÙŠÙ‡ Ø£ÙŠ Ø²ÙŠØ§Ø±Ø© Ù…Ø¹ØªÙ…Ø¯Ø©
      const finals = all.filter(r=>{
        const v=r.visits||{};
        return !!(v[1]?.finalized || v[2]?.finalized || v[3]?.finalized);
      });

      if(!finals.length){ listEl.innerHTML='Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¨Ø¹Ø¯.'; return; }

      listEl.innerHTML = finals.map(r=>{
        const v=r.visits||{};
        const c=(v[1]?.finalized?1:0)+(v[2]?.finalized?1:0)+(v[3]?.finalized?1:0);
        const dot=c===0?'ğŸŸ¥':(c===1?'ğŸŸ¨':'ğŸŸ©');
        const tail=r.nationalId?` (${r.nationalId})`:'';
        return `<span class="name-chip" data-key="${esc(r.teacherId)}">${dot} ${esc(r.name||'â€”')}${esc(tail)}</span>`;
      }).join('');

      // click to load
      listEl.querySelectorAll('[data-key]').forEach(ch=>{
        ch.addEventListener('click', async ()=>{
          const key=ch.getAttribute('data-key');
          try{
            const rec = await window.dbGet(key);
            if(!rec) return;
            el('tName').value = rec.name||'';
            el('tId').value = rec.nationalId||'';
            el('tSpec').value = rec.spec||'';
            el('degree').value = rec.degree||'';
            el('class').value = rec.class||'';
            el('lesson').value = rec.lesson||'';
            if(rec.email) el('mailTo').value = rec.email;
            if(rec.phone) el('waPhone').value = rec.phone;
            window.fixedKey = rec.teacherId;
            window.loadedRecord = rec;
            if(typeof window.renderFromRecord==="function") await window.renderFromRecord();
            toast('ØªÙ… ÙØªØ­ Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ø­Ø§ÙØ¸Ø©.');
            closeVault();
          }catch{}
        });
      });
    }catch{
      listEl.innerHTML='ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§ÙØ¸Ø©.';
    }
  }

  async function finalizeVisit(){
    try{
      if(typeof window.saveDraft==="function") await window.saveDraft();
      if(typeof window.ensureRecord!=="function"){ toast('ØªØ¹Ø°Ø± Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯.', false); return; }
      const rec = await window.ensureRecord();
      if(!rec){ toast('Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù… Ø£ÙˆÙ„Ø§Ù‹.', false); return; }
      const v = Number(window.activeVisit||1);
      rec.visits[v] = rec.visits[v] || {finalized:false,draft:{}};
      rec.visits[v].finalized = true;
      // ØªØ£ÙƒÙŠØ¯ Ø­ÙØ¸ Ø¢Ø®Ø± Ù…Ø³ÙˆØ¯Ø©
      rec.visits[v].draft = safeClone(rec.visits[v].draft || {});
      if(typeof window.dbPut==="function") await window.dbPut(rec);
      window.loadedRecord = rec;
      toast(`ØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø© ${visitLabel(v)}.`);
      try{ if(typeof window.refreshLens==="function") await window.refreshLens(); }catch{}
      refreshVault();
    }catch{
      toast('ØªØ¹Ø°Ø± Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯.', false);
    }
  }

  async function deleteActiveVisit(){
    const v = Number(window.activeVisit||1);
    if(!confirm(`ØªØ£ÙƒÙŠØ¯ Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø²ÙŠØ§Ø±Ø© ${visitLabel(v)} Ù„Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØŸ`)) return;

    try{
      if(typeof window.ensureRecord!=="function"){ toast('ØªØ¹Ø°Ø± Ø§Ù„Ù…Ø³Ø­.', false); return; }
      const rec = await window.ensureRecord();
      if(!rec){ toast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„.', false); return; }

      // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø²ÙŠØ§Ø±Ø©
      if(typeof window.zeroSupport==="function"){
        rec.visits[v] = {finalized:false, draft: window.zeroSupport()};
      }else{
        rec.visits[v] = {finalized:false, draft:{ratings:null,tools:[],reasons:[],support:[],supportDetailed:[],date:''}};
      }
      if(typeof window.dbPut==="function") await window.dbPut(rec);
      window.loadedRecord = rec;

      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„
      if(typeof window.renderFromRecord==="function") await window.renderFromRecord();
      toast(`ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø²ÙŠØ§Ø±Ø© ${visitLabel(v)}.`);
      try{ if(typeof window.refreshLens==="function") await window.refreshLens(); }catch{}
      refreshVault();
    }catch{
      toast('ØªØ¹Ø°Ø± Ù…Ø³Ø­ Ø§Ù„Ø²ÙŠØ§Ø±Ø©.', false);
    }
  }

  async function clearAllRecords(){
    if(!confirm('ØªØ£ÙƒÙŠØ¯ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª (Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø²)ØŸ')) return;
    try{
      if(typeof window.dbClear==="function") await window.dbClear();
      // ØªÙ†Ø¸ÙŠÙ ÙˆØ§Ø¬Ù‡Ø©
      ['tName','tId','tSpec','degree','class','lesson'].forEach(id=>{ if(el(id)) el(id).value=''; });
      if(el('supportArea')) el('supportArea').value='';
      window.loadedRecord=null; window.fixedKey=null;
      // Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡
      try{ if(typeof window.buildLearning==="function") window.buildLearning(); }catch{}
      try{ if(typeof window.buildTools==="function") window.buildTools(); }catch{}
      try{ if(typeof window.calcAll==="function") window.calcAll(); }catch{}
      toast('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª.');
      refreshVault();
      try{ if(typeof window.refreshLens==="function") await window.refreshLens(); }catch{}
    }catch{
      toast('ØªØ¹Ø°Ø± Ù…Ø³Ø­ Ø§Ù„Ø¬Ù…ÙŠØ¹.', false);
    }
  }

  /* =========
     Ø§Ù„Ø´Ø±Ø­ (Help Panel) + Ø£Ø³Ù‡Ù… Ø§Ù„ØªÙ…Ø±ÙŠØ±
     ========= */
  function fillHelpContent(){
    const b = el('helpBody');
    if(!b) return;
    b.innerHTML = `
      <h3>Ø¢Ù„ÙŠØ© Ø§Ù„Ø¹Ù…Ù„</h3>
      <ul>
        <li><span class="help-badge">Ù¡</span> Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù… (Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ù‡ÙˆÙŠØ©/Ø§Ù„ØªØ®ØµØµ/Ø§Ù„ÙØµÙ„/Ø§Ù„Ø¯Ø±Ø³).</li>
        <li><span class="help-badge">Ù¢</span> Ù‚ÙŠÙ‘Ù… Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„ØªØ¹Ù„Ù‘Ù… Ø¨Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø¯Ø§Ø¡.</li>
        <li><span class="help-badge">Ù£</span> Ø­Ø¯Ù‘Ø¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø§Ù†Ø¯Ø© ÙˆØ£Ø³Ø¨Ø§Ø¨ Ø¹Ø¯Ù… Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©.</li>
        <li><span class="help-badge">Ù¤</span> Ø³ÙŠÙÙˆÙ„Ù‘Ø¯ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¯Ø¹Ù…Ù‹Ø§ Ù…Ù‚ØªØ±Ø­Ù‹Ø§ (Ù¤ Ø£Ø³Ø·Ø±) ÙˆÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ ÙŠØ¯ÙˆÙŠÙ‹Ø§.</li>
        <li><span class="help-badge">Ù¥</span> Ø§Ø³ØªØ®Ø¯Ù… <b>Ø§Ø¹ØªÙ…Ø¯</b> Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ø²ÙŠØ§Ø±Ø© ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ ÙˆØ¸Ù‡ÙˆØ±Ù‡Ø§ Ø¨Ø§Ù„Ø­Ø§ÙØ¸Ø©.</li>
      </ul>

      <div class="help-note">
        <b>ØªÙ†Ø¨ÙŠÙ‡:</b> Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ø¯Ø¹Ù… ÙˆØªÙÙØªØ­ Ø¹Ù†Ø¯ Ø¶Ø¹Ù Ø§Ù„Ù…Ø¤Ø´Ø± ÙˆÙÙ‚ Ù…Ù†Ø·Ù‚ Ø§Ù„Ù†Ø¸Ø§Ù….
      </div>

      <h3>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø©</h3>
      <ul>
        <li><b>ØªÙ‚Ø±ÙŠØ±</b>: ÙŠÙØªØ­ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù…Ø¹ Ø²Ø± Ø·Ø¨Ø§Ø¹Ø©.</li>
        <li><b>Ø¨ÙŠ Ø¯ÙŠ Ø¥Ù</b>: ÙŠÙØªØ­ ØªÙ‚Ø±ÙŠØ±Ù‹Ø§ Ø´Ø§Ù…Ù„Ø§Ù‹ Ù„Ù„Ø²ÙŠØ§Ø±Ø§Øª 1-2-3 Ù…Ø¹ ØªÙ†Ø³ÙŠÙ‚ Ø·Ø¨Ø§Ø¹Ø© A4 ÙˆØªØ±ÙˆÙŠØ³Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø©.</li>
      </ul>

      <div class="help-privacy">
        <b>Ø®ØµÙˆØµÙŠØ©:</b> Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙØ­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ (IndexedDB/LocalStorage) ÙˆÙ„Ø§ ØªÙØ±ÙØ¹ Ù„Ø£ÙŠ Ø¬Ù‡Ø©.
      </div>
    `;
  }

  function openHelp(){
    const p = el('helpPanel');
    if(!p) return;
    fillHelpContent();
    p.style.display='block';
  }
  function closeHelp(){
    const p = el('helpPanel');
    if(p) p.style.display='none';
  }

  function bindScrollArrows(){
    const up=el('scrollUp'), down=el('scrollDown');
    if(up) up.onclick = ()=> window.scrollTo({top:0, behavior:'smooth'});
    if(down) down.onclick = ()=> window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'});
  }

  /* =========
     Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± (IDs Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø¹Ù†Ø¯Ùƒ)
     ========= */
  function bind(){
    // Ø§Ù„ØªÙ‚Ø±ÙŠØ±/Ø§Ù„Ù€PDF
    const bReport = el('btnReport');
    const bPDFAll = el('btnPDFAll');
    if(bReport) bReport.addEventListener('click', openReportSingle);
    if(bPDFAll) bPDFAll.addEventListener('click', openReportAll);

    // Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª
    const bComms = el('btnComms');
    if(bComms) bComms.addEventListener('click', openCommsPanel);
    el('commsClose')?.addEventListener('click', closeCommsPanel);
    el('btnMakeComms')?.addEventListener('click', makeComms);
    el('btnCopyComms')?.addEventListener('click', copyComms);
    el('btnOpenWA')?.addEventListener('click', openWA);
    el('btnOpenMail')?.addEventListener('click', openMail);
    el('editDefaults')?.addEventListener('click', saveCommsDefaults);
    el('btnFetchFromDB')?.addEventListener('click', fetchCommsFromDB);

    // Ø§Ù„Ø­Ø§ÙØ¸Ø©
    el('btnVault')?.addEventListener('click', openVault);
    el('apClose')?.addEventListener('click', closeVault);

    // Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯/Ø§Ù„Ù…Ø³Ø­
    el('btnFinalize')?.addEventListener('click', finalizeVisit);
    el('btnDeleteVisit')?.addEventListener('click', deleteActiveVisit);
    el('btnClearAll')?.addEventListener('click', clearAllRecords);

    // Ø£Ø²Ø±Ø§Ø± Ø¹Ø§Ø¦Ù…Ø©
    el('fabHelp')?.addEventListener('click', openHelp);
    el('helpClose')?.addEventListener('click', closeHelp);

    // Ø£Ø³Ù‡Ù… Ø§Ù„ØªÙ…Ø±ÙŠØ±
    bindScrollArrows();

    // Ù…Ù†ØµØ© Ø§Ù„ØªÙ†Ø¸ÙŠÙ… (Ø²Ø± fabHub) â€” Ù„Ø§ ØªØºÙŠÙ‘Ø± Ø§Ù„Ø±Ø§Ø¨Ø· Ø¥Ù† ÙƒØ§Ù† Ø¹Ù†Ø¯Ùƒ Ø³Ø§Ø¨Ù‚Ø§Ù‹ØŒ ÙÙ‚Ø· fallback Ù‡Ù†Ø§
    el('fabHub')?.addEventListener('click', ()=>{
      const url = (window.HUB_URL || 'https://fhz545-hub.github.io/');
      window.open(url,'_blank','noopener');
    });

    // Ø¥ØºÙ„Ø§Ù‚ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§
    document.addEventListener('click', (e)=>{
      const panel=el('commsPanel'), btn=el('btnComms');
      if(!panel || !btn) return;
      if(panel.style.display==='block' && !panel.contains(e.target) && !btn.contains(e.target)){
        // Ù„Ø§ ØªØºÙ„Ù‚ Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
        // (Ø®ÙŠØ§Ø± Ù…Ø­Ø§ÙØ¸)
      }
    });

    // ØªÙˆÙ„ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù†Øµ Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù… (Ø®ÙÙŠÙ)
    const auto = debounce(()=>{ try{ if(el('commsPanel')?.style.display==='block') makeComms(); }catch{} }, 240);
    ['tName','tId','tSpec','degree','class','lesson'].forEach(id=>{
      el(id)?.addEventListener('input', auto);
    });

    // Ø­Ù…Ù‘Ù„ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Øª Ù…Ø±Ø§Ø³Ù„Ø§Øª Ø¥Ù† ÙˆØ¬Ø¯Øª
    try{
      const m = localStorage.getItem('yaqfb_mailTo'); if(m && el('mailTo')) el('mailTo').value=m;
      const w = localStorage.getItem('yaqfb_waPhone'); if(w && el('waPhone')) el('waPhone').value=w;
    }catch{}
  }

  // ØªÙ†ÙÙŠØ° Ø§Ù„Ø±Ø¨Ø· Ø¨Ø¹Ø¯ Ø¬Ø§Ù‡Ø²ÙŠØ© DOM
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', bind);
  else bind();

})();
</script>
<!-- ============ /PART 19 ============ -->

</body>
</html>
<!-- ============ PART 20 / 20 ============ -->
